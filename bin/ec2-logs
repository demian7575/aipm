#!/bin/bash

# View live logs from AIPM EC2 services
# Usage: ./bin/ec2-logs [prod|dev] [service]

set -e

ENV=${1:-prod}
SERVICE=${2:-wrapper}

if [ "$ENV" != "prod" ] && [ "$ENV" != "dev" ]; then
  echo "Usage: $0 [prod|dev] [service]"
  echo ""
  echo "Services:"
  echo "  wrapper    - Kiro wrapper logs (default)"
  echo "  backend    - Backend API logs"
  echo "  semantic   - Semantic API logs"
  echo "  pool       - Session pool logs"
  echo "  all        - All services"
  exit 1
fi

# Get instance ID
if [ "$ENV" = "prod" ]; then
  INSTANCE_ID="i-016241c7a18884e80"
else
  INSTANCE_ID="i-0c5326fb2c8e6a2f7"
fi

# Get current IP
IP=$(aws ec2 describe-instances \
  --instance-ids "$INSTANCE_ID" \
  --region us-east-1 \
  --query 'Reservations[0].Instances[0].PublicIpAddress' \
  --output text)

if [ "$IP" = "None" ] || [ -z "$IP" ]; then
  echo "‚ùå Instance has no public IP. Is it running?"
  exit 1
fi

echo "üì° Connecting to $ENV EC2 ($IP)..."
echo ""

case "$SERVICE" in
  wrapper)
    echo "üîç Kiro wrapper logs (Ctrl+C to exit):"
    ssh ec2-user@$IP "tail -f /home/ec2-user/kiro-wrapper.log"
    ;;
  backend)
    echo "üîç Backend API logs (Ctrl+C to exit):"
    ssh ec2-user@$IP "sudo journalctl -u aipm-backend -f"
    ;;
  semantic)
    echo "üîç Semantic API logs (Ctrl+C to exit):"
    ssh ec2-user@$IP "sudo journalctl -u aipm-semantic-api -f"
    ;;
  pool)
    echo "üîç Session pool logs (Ctrl+C to exit):"
    ssh ec2-user@$IP "sudo journalctl -u kiro-session-pool-http -f"
    ;;
  all)
    echo "üîç All service logs (Ctrl+C to exit):"
    ssh ec2-user@$IP "sudo journalctl -u aipm-backend -u aipm-semantic-api -u kiro-session-pool-http -f"
    ;;
  *)
    echo "‚ùå Unknown service: $SERVICE"
    echo "Available: wrapper, backend, semantic, pool, all"
    exit 1
    ;;
esac
