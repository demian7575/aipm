#!/bin/bash

# View live logs from AIPM EC2 services
# Usage: ./bin/ec2-logs [prod|dev] [service]

set -e

ENV=${1:-prod}
SERVICE=${2:-wrapper}

if [ "$ENV" != "prod" ] && [ "$ENV" != "dev" ]; then
  echo "Usage: $0 [prod|dev] [service]"
  echo ""
  echo "Services:"
  echo "  wrapper    - Kiro wrapper logs (default)"
  echo "  backend    - Backend API logs"
  echo "  semantic   - Semantic API logs"
  echo "  pool       - Session pool logs"
  echo "  all        - All services"
  exit 1
fi

# Load config from environments.yaml
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
source "$PROJECT_ROOT/scripts/utilities/load-env-config.sh" "$ENV" > /dev/null

INSTANCE_ID="$INSTANCE_ID"

# Get current IP
IP=$(aws ec2 describe-instances \
  --instance-ids "$INSTANCE_ID" \
  --region us-east-1 \
  --query 'Reservations[0].Instances[0].PublicIpAddress' \
  --output text)

if [ "$IP" = "None" ] || [ -z "$IP" ]; then
  echo "âŒ Instance has no public IP. Is it running?"
  exit 1
fi

echo "ğŸ“¡ Connecting to $ENV EC2 ($IP)..."
echo ""

case "$SERVICE" in
  wrapper)
    echo "ğŸ” Kiro wrapper logs (Ctrl+C to exit):"
    ssh -o StrictHostKeyChecking=no ec2-user@$IP "tail -f /home/ec2-user/kiro-wrapper.log"
    ;;
  backend)
    echo "ğŸ” Backend API logs (Ctrl+C to exit):"
    ssh -o StrictHostKeyChecking=no ec2-user@$IP "sudo journalctl -u aipm-backend -f"
    ;;
  semantic)
    echo "ğŸ” Semantic API logs (Ctrl+C to exit):"
    ssh -o StrictHostKeyChecking=no ec2-user@$IP "sudo journalctl -u aipm-semantic-api -f"
    ;;
  pool)
    echo "ğŸ” Session pool logs (Ctrl+C to exit):"
    ssh -o StrictHostKeyChecking=no ec2-user@$IP "sudo journalctl -u kiro-session-pool-http -f"
    ;;
  all)
    echo "ğŸ” All service logs (Ctrl+C to exit):"
    ssh -o StrictHostKeyChecking=no ec2-user@$IP "sudo journalctl -u aipm-backend -u aipm-semantic-api -u kiro-session-pool-http -f"
    ;;
  *)
    echo "âŒ Unknown service: $SERVICE"
    echo "Available: wrapper, backend, semantic, pool, all"
    exit 1
    ;;
esac
