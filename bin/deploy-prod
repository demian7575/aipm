#!/bin/bash
set -e

# Enable debug output for GitHub Actions
if [[ -n "$GITHUB_ACTIONS" ]]; then
    set -x
fi

ENV=$1
if [[ -z "$ENV" ]]; then
    echo "Usage: $0 <prod|dev>"
    echo "  prod - Deploy to production environment"
    echo "  dev  - Deploy to development environment"
    exit 1
fi

# Load environment configuration from centralized YAML
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../scripts/utilities/load-env-config.sh" "$ENV"

# Map to deployment variables
HOST="$EC2_IP"
SERVICE="aipm-backend"
FRONTEND_BUCKET="$S3_BUCKET"
API_URL="$API_BASE"
STORIES_TABLE="$DYNAMODB_STORIES_TABLE"
TESTS_TABLE="$DYNAMODB_TESTS_TABLE"
PRS_TABLE="$DYNAMODB_PRS_TABLE"
SEMANTIC_QUEUE_TABLE="aipm-semantic-api-queue-${ENV}"

echo "ðŸš€ Deploying to $ENV environment..."
echo "ðŸ“ Host: $HOST"
echo "ðŸª£ Frontend: $FRONTEND_BUCKET"

# Create DynamoDB tables if needed
echo "ðŸ—„ï¸  Ensuring DynamoDB tables exist..."
export SEMANTIC_QUEUE_TABLE
./scripts/create-semantic-queue-table.sh || echo "âš ï¸  Table creation skipped"

# Deploy backend
echo "ðŸ“¦ Deploying backend..."

# Check if we're in GitHub Actions environment
if [[ -n "$GITHUB_ACTIONS" ]]; then
    echo "ðŸ”§ GitHub Actions environment detected - using simplified deployment"
    
    # SSH key should already be configured by the workflow
    if [[ ! -f ~/.ssh/id_rsa ]]; then
        echo "âŒ SSH key not found - should be configured by workflow"
        exit 1
    fi
    
    echo "âœ… Using SSH key configured by workflow"
    
    # Get current branch for PR deployments
    CURRENT_BRANCH=$(git branch --show-current)
    if [[ "$CURRENT_BRANCH" == "main" ]]; then
        TARGET_BRANCH="main"
    else
        TARGET_BRANCH="$CURRENT_BRANCH"
    fi
    
    echo "ðŸ“ Deploying branch: $TARGET_BRANCH"
    
    # Generate deployment metadata
    COMMIT_HASH=$(git rev-parse --short HEAD)
    DEPLOY_VERSION=$(date +"%Y%m%d-%H%M%S")
    
    # Extract PR number if available
    PR_NUMBER="$ENV"
    if [[ -n "$GITHUB_HEAD_REF" ]]; then
        PR_NUMBER=$(echo "$GITHUB_HEAD_REF" | grep -o '[0-9]\+' | head -1 || echo "$ENV")
    elif [[ "$TARGET_BRANCH" =~ [0-9]+ ]]; then
        PR_NUMBER=$(echo "$TARGET_BRANCH" | grep -o '[0-9]\+' | head -1 || echo "$ENV")
    fi
    
    echo "ðŸ”„ Simplified deployment to $HOST..."
    
    # Simplified deployment: fetch and checkout the correct branch
    # Create deployment script on remote host
    cat > /tmp/deploy_commands.sh << 'EOF'
cd aipm
echo 'Fetching latest code...'
git fetch origin
if [ "$1" != "main" ]; then
    echo "Fetching PR branch: $1"
    git fetch origin $1:$1
fi
echo "Checking out branch: $1"
git checkout $1
git reset --hard origin/$1
echo "Code updated successfully to branch: $1"

# Install Git hooks to prevent committing broken code
if [ -f scripts/install-hooks.sh ]; then
    echo "Installing Git hooks..."
    bash scripts/install-hooks.sh
fi
EOF
    
    scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no /tmp/deploy_commands.sh ec2-user@$HOST:/tmp/
    ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@$HOST bash /tmp/deploy_commands.sh $TARGET_BRANCH 2>/dev/null || {
        echo "âš ï¸ Git operations had warnings, verifying success..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@$HOST 'cd aipm && git branch --show-current' > /tmp/current_branch 2>/dev/null
        cat /tmp/current_branch 2>/dev/null > /tmp/branch_name || echo "unknown" > /tmp/branch_name
        read CURRENT_BRANCH < /tmp/branch_name
        rm -f /tmp/current_branch /tmp/branch_name
        if [[ "$CURRENT_BRANCH" == "$TARGET_BRANCH" ]]; then
            echo "âœ… Git operations completed successfully - on branch: $CURRENT_BRANCH"
        else
            echo "âŒ Git operations failed - expected: $TARGET_BRANCH, actual: $CURRENT_BRANCH"
            exit 1
        fi
    }
    
    # Update environment configuration
    echo "âš™ï¸ Updating environment configuration..."
    
    # Copy static environment file and add dynamic variables
    cat > /tmp/env_config.sh << EOF
cd aipm
# Copy static environment file
cp /tmp/static.env .env
# Add dynamic variables
echo "DEPLOY_VERSION=$DEPLOY_VERSION" >> .env
echo "COMMIT_HASH=$COMMIT_HASH" >> .env
echo "PROD_VERSION=$DEPLOY_VERSION" >> .env
echo "BASE_VERSION=$DEPLOY_VERSION" >> .env
echo "PR_NUMBER=$PR_NUMBER" >> .env
echo "GITHUB_TOKEN=\${GITHUB_TOKEN:-PLACEHOLDER_TOKEN}" >> .env
EOF
    
    # Copy static environment file to server
    scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no config/$ENV.env ec2-user@$HOST:/tmp/static.env
    scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no /tmp/env_config.sh ec2-user@$HOST:/tmp/
    ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@$HOST bash /tmp/env_config.sh
    
    # Replace version placeholder in backend app.js
    echo "ðŸ”„ Updating backend version..."
    ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@$HOST "cd aipm/apps/backend && sed -i.bak 's/DEPLOYMENT_VERSION_PLACEHOLDER/${DEPLOY_VERSION}/g' app.js && rm -f app.js.bak"
    
    # Restart services
    echo "ðŸ”„ Restarting services..."
    SERVICE_NAME="aipm-${ENV}-backend.service"
    if [[ "$ENV" == "prod" ]]; then
        SERVICE_NAME="aipm-backend.service"
    fi
    
    cat > /tmp/restart_services.sh << EOF
cd aipm
echo 'Restarting $SERVICE_NAME...'
sudo systemctl restart $SERVICE_NAME

echo 'Installing/updating Kiro services...'
sudo cp scripts/systemd/aipm-kiro-api.service /etc/systemd/system/
sudo cp scripts/systemd/aipm-kiro-cli.service /etc/systemd/system/
sudo cp scripts/systemd/kiro-session-pool.service /etc/systemd/system/
sudo cp scripts/systemd/aipm-semantic-api.service /etc/systemd/system/
sudo cp scripts/systemd/aipm-semantic-worker.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable aipm-kiro-api aipm-kiro-cli kiro-session-pool aipm-semantic-api aipm-semantic-worker
sudo systemctl restart kiro-session-pool
sudo systemctl restart aipm-kiro-cli
sudo systemctl restart aipm-kiro-api
sudo systemctl restart aipm-semantic-api
sudo systemctl restart aipm-semantic-worker

echo 'Waiting for services to start...'
sleep 5
sudo systemctl status $SERVICE_NAME --no-pager
echo 'Service restarted successfully'
EOF
    scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no /tmp/restart_services.sh ec2-user@$HOST:/tmp/
    ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@$HOST bash /tmp/restart_services.sh
    
    echo "âœ… Backend deployed successfully"
fi

# Deploy frontend
echo "ðŸŒ Deploying frontend..."

# Generate deployment version if not set (for local deployments)
if [[ -z "$DEPLOY_VERSION" ]]; then
    DEPLOY_VERSION=$(date +"%Y%m%d-%H%M%S")
    echo "ðŸ“… Generated deployment version: $DEPLOY_VERSION"
fi

# Copy correct config file for environment and replace version
if [[ "$ENV" == "prod" ]]; then
    cp apps/frontend/public/config-prod.js apps/frontend/public/config.js
    # Replace version placeholder with actual deployment version
    sed -i.bak "s/DEPLOYMENT_VERSION_PLACEHOLDER/${DEPLOY_VERSION}/g" apps/frontend/public/config.js
    rm -f apps/frontend/public/config.js.bak
else
    cp apps/frontend/public/config-dev.js apps/frontend/public/config.js
    # For dev, use timestamp
    DEV_VERSION="dev-${DEPLOY_VERSION}"
    sed -i.bak "s/dev-TIMESTAMP/${DEV_VERSION}/g" apps/frontend/public/config.js
    rm -f apps/frontend/public/config.js.bak
fi

# Upload to S3
aws s3 sync apps/frontend/public/ s3://$FRONTEND_BUCKET/ --exclude "*.md" --exclude ".DS_Store" --exclude "config-*.js"
echo "âœ… Frontend deployed to S3"

# Verify deployment
echo "ðŸ” Verifying deployment..."
sleep 5

# Test backend health
if curl -s --connect-timeout 10 "$API_URL/api/version" | grep -q "version"; then
    echo "âœ… Backend is responding"
else
    echo "âš ï¸ Backend health check failed (may still be starting)"
fi

# Test frontend
if [[ "$ENV" == "prod" ]]; then
    FRONTEND_URL="http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com"
else
    FRONTEND_URL="http://aipm-dev-frontend-hosting.s3-website-us-east-1.amazonaws.com"
fi

if curl -s --connect-timeout 10 "$FRONTEND_URL" | grep -q "html"; then
    echo "âœ… Frontend is accessible"
else
    echo "âš ï¸ Frontend health check failed"
fi

# Run structured gating tests
echo ""
echo "ðŸ§ª Running structured gating tests..."
if ./scripts/testing/run-structured-gating-tests.sh --env $ENV; then
    echo "âœ… All gating tests passed"
else
    echo "âŒ Gating tests failed"
    exit 1
fi

echo "ðŸŽ‰ Deployment to $ENV completed successfully!"
