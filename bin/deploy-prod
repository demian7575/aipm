#!/bin/bash
set -e

# Parse arguments
ENV=$1
SKIP_TESTS=${2:-false}

if [[ -z "$ENV" ]]; then
    echo "Usage: $0 <prod|dev> [skip-tests]"
    echo "  prod - Deploy to production environment"
    echo "  dev  - Deploy to development environment"
    echo "  skip-tests - Optional: skip gating tests"
    exit 1
fi

# Load environment configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../scripts/utilities/load-env-config.sh" "$ENV"

HOST="$EC2_IP"
FRONTEND_BUCKET="$S3_BUCKET"
FRONTEND_URL="$S3_URL"

echo "ðŸš€ Deploying to $ENV environment..."
echo "ðŸ“ Host: $HOST"
echo "ðŸª£ Frontend: $FRONTEND_BUCKET"

# Check if we're running on the target EC2 instance
CURRENT_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "")
if [[ "$CURRENT_IP" == "$HOST" ]]; then
    echo "ðŸ  Running on target EC2 - deploying locally"
    
    # Deploy backend locally
    echo "ðŸ“¦ Updating backend code..."
    cd /home/ec2-user/aipm
    git fetch origin
    git reset --hard origin/main
    echo "âœ… Code updated"
    
    # Restart backend service
    echo "ðŸ”„ Restarting backend service..."
    sudo systemctl restart aipm-backend
    sleep 3
    sudo systemctl status aipm-backend --no-pager
    echo "âœ… Backend service restarted"
    
    cd - > /dev/null
else
    echo "ðŸŒ Running remotely - deploying via SSH"
    
    # Ensure SSH key exists
    if [[ ! -f ~/.ssh/id_rsa ]]; then
        echo "âŒ SSH key not found at ~/.ssh/id_rsa"
        exit 1
    fi

    # Add host to known_hosts
    if ! grep -q "$HOST" ~/.ssh/known_hosts 2>/dev/null; then
        echo "ðŸ”‘ Adding $HOST to known_hosts..."
        ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null
    fi

    # Deploy backend via SSH
    echo "ðŸ“¦ Deploying backend to EC2..."
    ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@$HOST << 'ENDSSH'
cd aipm
git fetch origin
git reset --hard origin/main
echo "âœ… Code updated"
ENDSSH

    # Restart backend service via SSH
    echo "ðŸ”„ Restarting backend service..."
    ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@$HOST << 'ENDSSH'
sudo systemctl restart aipm-backend
sleep 3
sudo systemctl status aipm-backend --no-pager
echo "âœ… Backend service restarted"
ENDSSH
fi

echo "âœ… Backend deployed"

# Deploy frontend
echo "ðŸŒ Deploying frontend to S3..."
aws s3 sync apps/frontend/public/ s3://$FRONTEND_BUCKET/ --exclude "*.md" --exclude ".DS_Store"
echo "âœ… Frontend deployed to S3"

# Verify deployment
echo "ðŸ” Verifying deployment..."
sleep 3

if curl -s --connect-timeout 10 "$API_BASE/api/version" | grep -q "version"; then
    echo "âœ… Backend is responding"
else
    echo "âš ï¸  Backend health check failed (may still be starting)"
fi

if curl -s --connect-timeout 10 "$FRONTEND_URL" | grep -q "html"; then
    echo "âœ… Frontend is accessible"
else
    echo "âš ï¸  Frontend health check failed"
fi

# Run gating tests unless skipped
if [[ "$SKIP_TESTS" != "skip-tests" ]]; then
    echo ""
    echo "ðŸ§ª Running structured gating tests..."
    if ./scripts/testing/run-structured-gating-tests.sh $ENV; then
        echo "âœ… All gating tests passed"
    else
        echo "âŒ Gating tests failed"
        exit 1
    fi
else
    echo "â­ï¸  Skipping gating tests"
fi

echo "ðŸŽ‰ Deployment to $ENV completed successfully!"
