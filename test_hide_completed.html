<!DOCTYPE html>
<html>
<head>
    <title>Test Hide Completed Stories</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Hide Completed Stories Feature Test</h1>
    <div id="test-results"></div>
    
    <script>
        // Mock localStorage
        const mockStorage = {};
        const localStorage = {
            getItem: (key) => mockStorage[key] || null,
            setItem: (key, value) => mockStorage[key] = value,
            removeItem: (key) => delete mockStorage[key]
        };
        
        // Mock state and functions
        const STORAGE_KEYS = { hideCompleted: 'aiPm.hideCompleted' };
        const state = { hideCompleted: false, stories: [] };
        
        function persistHideCompleted() {
            localStorage.setItem(STORAGE_KEYS.hideCompleted, JSON.stringify(state.hideCompleted));
        }
        
        function getVisibleStories() {
            if (!state.hideCompleted) return state.stories;
            return state.stories.filter(story => story.status !== 'Done');
        }
        
        function getVisibleMindmapStories(stories) {
            const filterDoneStories = (entries) => {
                return entries
                    .filter((story) => story && (!state.hideCompleted || story.status !== 'Done'))
                    .map((story) => ({
                        ...story,
                        children: story.children ? filterDoneStories(story.children) : [],
                    }));
            };
            return filterDoneStories(Array.isArray(stories) ? stories : []);
        }
        
        // Test data
        const testStories = [
            { id: 1, title: 'Active Story', status: 'In Progress' },
            { id: 2, title: 'Done Story', status: 'Done' },
            { id: 3, title: 'Ready Story', status: 'Ready' },
            { id: 4, title: 'Parent Story', status: 'In Progress', children: [
                { id: 5, title: 'Done Child', status: 'Done' },
                { id: 6, title: 'Active Child', status: 'In Progress' }
            ]}
        ];
        
        // Run tests
        function runTests() {
            const results = [];
            
            // Test 1: Show all stories when hideCompleted is false
            state.hideCompleted = false;
            state.stories = testStories;
            const allVisible = getVisibleStories();
            results.push({
                name: 'Show all stories when hideCompleted is false',
                pass: allVisible.length === 4,
                details: `Expected 4 stories, got ${allVisible.length}`
            });
            
            // Test 2: Hide completed stories when hideCompleted is true
            state.hideCompleted = true;
            const filteredVisible = getVisibleStories();
            results.push({
                name: 'Hide completed stories when hideCompleted is true',
                pass: filteredVisible.length === 3 && !filteredVisible.some(s => s.status === 'Done'),
                details: `Expected 3 non-Done stories, got ${filteredVisible.length}`
            });
            
            // Test 3: Mindmap filtering with children
            const mindmapVisible = getVisibleMindmapStories(testStories);
            const parentStory = mindmapVisible.find(s => s.id === 4);
            results.push({
                name: 'Mindmap filters children correctly',
                pass: parentStory && parentStory.children.length === 1 && parentStory.children[0].id === 6,
                details: `Expected 1 active child, got ${parentStory ? parentStory.children.length : 0}`
            });
            
            // Test 4: localStorage persistence
            persistHideCompleted();
            const stored = localStorage.getItem(STORAGE_KEYS.hideCompleted);
            results.push({
                name: 'localStorage persistence works',
                pass: stored === 'true',
                details: `Expected 'true', got '${stored}'`
            });
            
            return results;
        }
        
        // Display results
        const testResults = runTests();
        const resultsDiv = document.getElementById('test-results');
        
        testResults.forEach(result => {
            const div = document.createElement('div');
            div.className = `test-result ${result.pass ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <strong>${result.pass ? '✓ PASS' : '✗ FAIL'}</strong>: ${result.name}<br>
                <small>${result.details}</small>
            `;
            resultsDiv.appendChild(div);
        });
        
        const passCount = testResults.filter(r => r.pass).length;
        const summary = document.createElement('div');
        summary.innerHTML = `<h2>Summary: ${passCount}/${testResults.length} tests passed</h2>`;
        resultsDiv.insertBefore(summary, resultsDiv.firstChild);
    </script>
</body>
</html>
