<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story List - AI Project Manager</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .story-list-container {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }
    .story-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    .story-table th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      border-bottom: 2px solid #ddd;
    }
    .story-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    .story-table tr:hover {
      background: #f9f9f9;
      cursor: pointer;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-Done { background: #d4edda; color: #155724; }
    .status-In-Progress { background: #d1ecf1; color: #0c5460; }
    .status-Ready { background: #fff3cd; color: #856404; }
    .status-Draft { background: #e2e3e5; color: #383d41; }
    .status-Blocked { background: #f8d7da; color: #721c24; }
    .status-Approved { background: #cce5ff; color: #004085; }
    .pagination {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      align-items: center;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="title-group">
      <h1>Story List</h1>
      <button onclick="window.location.href='index.html'" class="secondary">Back to Mindmap</button>
    </div>
  </header>

  <div class="story-list-container">
    <div class="filters">
      <label>
        Status:
        <select id="statusFilter">
          <option value="">All</option>
          <option value="Draft">Draft</option>
          <option value="Ready">Ready</option>
          <option value="In Progress">In Progress</option>
          <option value="Blocked">Blocked</option>
          <option value="Approved">Approved</option>
          <option value="Done">Done</option>
        </select>
      </label>
      <label>
        Sort by:
        <select id="sortBy">
          <option value="">Default</option>
          <option value="title">Title</option>
          <option value="status">Status</option>
          <option value="priority">Priority</option>
        </select>
      </label>
    </div>

    <table class="story-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="storyTableBody">
        <tr><td colspan="3">Loading...</td></tr>
      </tbody>
    </table>

    <div class="pagination">
      <button id="prevPage" class="secondary">Previous</button>
      <span id="pageInfo">Page 1 of 1</span>
      <button id="nextPage" class="secondary">Next</button>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentPage = 1;
    let totalPages = 1;

    async function loadStories() {
      const status = document.getElementById('statusFilter').value;
      const sortBy = document.getElementById('sortBy').value;
      
      const params = new URLSearchParams({
        page: currentPage,
        limit: 20
      });
      if (status) params.append('status', status);
      if (sortBy) params.append('sortBy', sortBy);

      const response = await fetch(`${API_BASE}/api/stories?${params}`);
      const data = await response.json();
      
      const tbody = document.getElementById('storyTableBody');
      tbody.innerHTML = '';
      
      if (data.stories && data.stories.length > 0) {
        data.stories.forEach(story => {
          const row = document.createElement('tr');
          row.onclick = () => window.location.href = `index.html?story=${story.id}`;
          
          const statusClass = story.status.replace(/\s+/g, '-');
          row.innerHTML = `
            <td>${story.title}</td>
            <td>${story.description.substring(0, 100)}${story.description.length > 100 ? '...' : ''}</td>
            <td><span class="status-badge status-${statusClass}">${story.status}</span></td>
          `;
          tbody.appendChild(row);
        });
        
        totalPages = data.pagination.totalPages;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
      } else {
        tbody.innerHTML = '<tr><td colspan="3">No stories found</td></tr>';
      }
    }

    document.getElementById('statusFilter').addEventListener('change', () => {
      currentPage = 1;
      loadStories();
    });
    
    document.getElementById('sortBy').addEventListener('change', () => {
      currentPage = 1;
      loadStories();
    });
    
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadStories();
      }
    });
    
    document.getElementById('nextPage').addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        loadStories();
      }
    });

    loadStories();
  </script>
</body>
</html>
