<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story List - AIPM</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .story-list-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .story-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .filters {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .story-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .story-table th {
      background: #f5f5f5;
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #ddd;
      cursor: pointer;
      user-select: none;
    }
    .story-table th:hover {
      background: #e8e8e8;
    }
    .story-table th.sortable::after {
      content: ' ⇅';
      opacity: 0.3;
    }
    .story-table th.sorted-asc::after {
      content: ' ↑';
      opacity: 1;
    }
    .story-table th.sorted-desc::after {
      content: ' ↓';
      opacity: 1;
    }
    .story-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #eee;
    }
    .story-table tr:hover {
      background: #f9f9f9;
      cursor: pointer;
    }
    .story-title {
      font-weight: 500;
      color: #333;
    }
    .story-description {
      color: #666;
      font-size: 0.9rem;
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .status-draft { background: #e3f2fd; color: #1976d2; }
    .status-ready { background: #e8f5e9; color: #388e3c; }
    .status-in-progress { background: #fff3e0; color: #f57c00; }
    .status-blocked { background: #ffebee; color: #d32f2f; }
    .status-approved { background: #f3e5f5; color: #7b1fa2; }
    .status-done { background: #e0e0e0; color: #424242; }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .pagination button {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination button:not(:disabled):hover {
      background: #f5f5f5;
    }
    .page-info {
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="story-list-container">
    <div class="story-list-header">
      <h1>User Stories</h1>
      <div class="filters">
        <label>
          Status:
          <select id="status-filter">
            <option value="">All</option>
            <option value="Draft">Draft</option>
            <option value="Ready">Ready</option>
            <option value="In Progress">In Progress</option>
            <option value="Blocked">Blocked</option>
            <option value="Approved">Approved</option>
            <option value="Done">Done</option>
          </select>
        </label>
        <button id="back-btn" class="secondary">← Back to Mindmap</button>
      </div>
    </div>

    <table class="story-table">
      <thead>
        <tr>
          <th class="sortable" data-sort="title">Title</th>
          <th class="sortable" data-sort="description">Description</th>
          <th class="sortable" data-sort="status">Status</th>
          <th class="sortable" data-sort="createdAt">Created</th>
        </tr>
      </thead>
      <tbody id="story-tbody">
        <tr><td colspan="4" style="text-align: center; padding: 2rem;">Loading stories...</td></tr>
      </tbody>
    </table>

    <div class="pagination">
      <button id="prev-btn" disabled>Previous</button>
      <span class="page-info" id="page-info">Page 1 of 1</span>
      <button id="next-btn" disabled>Next</button>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.CONFIG?.API_BASE_URL || 'http://localhost:4000';
    const STORIES_PER_PAGE = 20;
    
    let allStories = [];
    let filteredStories = [];
    let currentPage = 1;
    let sortField = 'createdAt';
    let sortDirection = 'desc';

    async function loadStories() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/stories`);
        if (!response.ok) throw new Error('Failed to load stories');
        const data = await response.json();
        allStories = flattenStories(data);
        applyFilters();
      } catch (error) {
        console.error('Error loading stories:', error);
        document.getElementById('story-tbody').innerHTML = 
          '<tr><td colspan="4" style="text-align: center; color: red;">Error loading stories</td></tr>';
      }
    }

    function flattenStories(stories) {
      const result = [];
      function traverse(story) {
        result.push(story);
        if (story.children) {
          story.children.forEach(traverse);
        }
      }
      stories.forEach(traverse);
      return result;
    }

    function applyFilters() {
      const statusFilter = document.getElementById('status-filter').value;
      filteredStories = allStories.filter(story => {
        if (statusFilter && story.status !== statusFilter) return false;
        return true;
      });
      sortStories();
      currentPage = 1;
      renderStories();
    }

    function sortStories() {
      filteredStories.sort((a, b) => {
        let aVal = a[sortField];
        let bVal = b[sortField];
        
        if (sortField === 'createdAt') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        } else if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function renderStories() {
      const tbody = document.getElementById('story-tbody');
      const start = (currentPage - 1) * STORIES_PER_PAGE;
      const end = start + STORIES_PER_PAGE;
      const pageStories = filteredStories.slice(start, end);
      
      if (pageStories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No stories found</td></tr>';
        updatePagination();
        return;
      }
      
      tbody.innerHTML = pageStories.map(story => `
        <tr onclick="viewStory(${story.id})">
          <td class="story-title">${escapeHtml(story.title)}</td>
          <td class="story-description">${escapeHtml(story.description || '')}</td>
          <td><span class="status-badge status-${story.status.toLowerCase().replace(' ', '-')}">${escapeHtml(story.status)}</span></td>
          <td>${new Date(story.createdAt).toLocaleDateString()}</td>
        </tr>
      `).join('');
      
      updatePagination();
      updateSortIndicators();
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredStories.length / STORIES_PER_PAGE);
      document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prev-btn').disabled = currentPage === 1;
      document.getElementById('next-btn').disabled = currentPage >= totalPages;
    }

    function updateSortIndicators() {
      document.querySelectorAll('.story-table th').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === sortField) {
          th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function viewStory(storyId) {
      window.location.href = `index.html?story=${storyId}`;
    }

    // Event listeners
    document.getElementById('status-filter').addEventListener('change', applyFilters);
    
    document.getElementById('prev-btn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderStories();
      }
    });
    
    document.getElementById('next-btn').addEventListener('click', () => {
      const totalPages = Math.ceil(filteredStories.length / STORIES_PER_PAGE);
      if (currentPage < totalPages) {
        currentPage++;
        renderStories();
      }
    });
    
    document.querySelectorAll('.story-table th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.sort;
        if (sortField === field) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = field;
          sortDirection = 'asc';
        }
        sortStories();
        renderStories();
      });
    });
    
    document.getElementById('back-btn').addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Load stories on page load
    loadStories();
  </script>
</body>
</html>
