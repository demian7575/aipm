<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kiro Live Log</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Courier New', monospace; background: #000; color: #0f0; height: 100vh; display: flex; flex-direction: column; }
    .header { background: #111; padding: 10px 15px; border-bottom: 1px solid #333; }
    .logs { flex: 1; overflow-y: auto; padding: 15px; font-size: 13px; line-height: 1.6; white-space: pre-wrap; }
    .controls { padding: 10px; background: #111; border-top: 1px solid #333; }
    .command-input { padding: 10px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px; }
    .command-input input { flex: 1; background: #000; color: #0f0; border: 1px solid #333; padding: 8px; font-family: 'Courier New', monospace; }
    .command-input input:focus { outline: none; border-color: #0f0; }
    button { background: #333; color: #0f0; border: 1px solid #555; padding: 8px 16px; margin-right: 10px; cursor: pointer; }
    button:hover { background: #555; }
    button:disabled { background: #222; color: #666; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="header">
    <h2>ü§ñ Kiro Live Log - /tmp/kiro-cli-live.log</h2>
  </div>
  
  <div class="logs" id="logs">Loading...</div>
  
  <div class="controls">
    <button onclick="refreshLog()">üîÑ Refresh</button>
    <button onclick="toggleAutoRefresh()" id="toggleBtn">‚è∏Ô∏è Pause</button>
  </div>

  <div class="command-input">
    <input type="text" id="commandInput" placeholder="Enter Kiro command..." />
    <button onclick="sendCommand()" id="sendBtn">Send</button>
  </div>

  <script src="../config.js?v=20260203"></script>
  <script>
    const logsEl = document.getElementById('logs');
    const toggleBtn = document.getElementById('toggleBtn');
    const commandInput = document.getElementById('commandInput');
    const sendBtn = document.getElementById('sendBtn');
    let autoRefresh = true;
    let interval;
    let lastContent = '';

    // Compute URLs from API_BASE_URL by replacing port
    const API_BASE_URL = window.CONFIG?.API_BASE_URL || 'http://localhost:4000';
    const SESSION_POOL_URL = API_BASE_URL.replace(':4000', ':8082');
    
    console.log('Config loaded:', window.CONFIG);
    console.log('Using API_BASE_URL:', API_BASE_URL);
    console.log('Using SESSION_POOL_URL:', SESSION_POOL_URL);

    async function fetchLog() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/kiro-live-log`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        // Skip processing if content hasn't changed
        if (data.content === lastContent) return;
        lastContent = data.content;
        
        // Keep only last 300 lines
        const lines = (data.content || 'Log file is empty').split('\n');
        const limitedContent = lines.slice(-300).join('\n');
        
        // Convert ANSI codes to HTML
        const coloredContent = convertAnsiToHtml(limitedContent);
        
        logsEl.innerHTML = coloredContent;
        logsEl.scrollTop = logsEl.scrollHeight;
      } catch (error) {
        logsEl.textContent = `Error fetching log: ${error.message}\n\nFallback content:\n[${new Date().toISOString()}] Kiro CLI live log viewer\n[${new Date().toISOString()}] Waiting for log updates...`;
      }
    }

    function convertAnsiToHtml(text) {
      // ANSI color map
      const colors = {
        '0': 'reset',
        '1': 'bold',
        '30': '#000', '31': '#f00', '32': '#0f0', '33': '#ff0',
        '34': '#00f', '35': '#f0f', '36': '#0ff', '37': '#fff',
        '90': '#666', '91': '#f66', '92': '#6f6', '93': '#ff6',
        '94': '#66f', '95': '#f6f', '96': '#6ff', '97': '#fff'
      };
      
      // 256-color support (38;5;n format)
      const get256Color = (n) => {
        if (n < 16) return colors[n] || '#fff';
        if (n < 232) {
          const r = Math.floor((n - 16) / 36) * 51;
          const g = Math.floor(((n - 16) % 36) / 6) * 51;
          const b = ((n - 16) % 6) * 51;
          return `rgb(${r},${g},${b})`;
        }
        const gray = 8 + (n - 232) * 10;
        return `rgb(${gray},${gray},${gray})`;
      };
      
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>');
      
      // Convert ANSI codes to HTML spans
      html = html
        .replace(/\x1b\[0m/g, '</span>')
        .replace(/\x1b\[1m/g, '<span style="font-weight:bold">')
        .replace(/\x1b\[38;5;(\d+)m/g, (match, n) => `<span style="color:${get256Color(parseInt(n))}">`)
        .replace(/\x1b\[(\d+)m/g, (match, code) => {
          const color = colors[code];
          if (color === 'reset') return '</span>';
          if (color === 'bold') return '<span style="font-weight:bold">';
          if (color) return `<span style="color:${color}">`;
          return '';
        });
      
      return html;
    }

    async function sendCommand() {
      const command = commandInput.value.trim();
      if (!command) return;
      
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      try {
        const response = await fetch(`${SESSION_POOL_URL}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: command
          })
        });
        
        if (response.ok) {
          commandInput.value = '';
          // Refresh log to show new command output
          setTimeout(fetchLog, 1000);
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        alert(`Command failed: ${error.message}`);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    }

    // Enter key to send command
    commandInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendCommand();
    });

    function refreshLog() {
      fetchLog();
    }

    function toggleAutoRefresh() {
      if (autoRefresh) {
        clearInterval(interval);
        toggleBtn.textContent = '‚ñ∂Ô∏è Resume';
        autoRefresh = false;
      } else {
        startAutoRefresh();
        toggleBtn.textContent = '‚è∏Ô∏è Pause';
        autoRefresh = true;
      }
    }

    function startAutoRefresh() {
      interval = setInterval(fetchLog, 2000);
    }

    // Initialize
    fetchLog();
    startAutoRefresh();
  </script>
</body>
</html>
