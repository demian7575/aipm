<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kiro Live Terminal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Courier New', monospace; background: #000; color: #0f0; height: 100vh; display: flex; flex-direction: column; }
    .header { background: #111; padding: 10px 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .header h2 { font-size: 16px; }
    .status { font-size: 12px; color: #888; }
    .status.connected { color: #0f0; }
    .status.disconnected { color: #f00; }
    .logs { flex: 1; overflow-y: auto; padding: 15px; font-size: 13px; line-height: 1.6; }
    .log-entry { margin-bottom: 5px; white-space: pre-wrap; word-break: break-all; }
    .log-entry.info { color: #0ff; }
    .log-entry.success { color: #0f0; }
    .log-entry.error { color: #f00; }
    .log-entry.warning { color: #ff0; }
    .controls { display: flex; padding: 10px; background: #111; border-top: 1px solid #333; gap: 10px; }
    button { background: #333; color: #0f0; border: 1px solid #555; padding: 10px 20px; cursor: pointer; font-family: 'Courier New', monospace; }
    button:hover { background: #555; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="header">
    <h2>ü§ñ Kiro Live Terminal</h2>
    <div class="status" id="status">‚è≥ Loading...</div>
  </div>
  
  <div class="logs" id="logs"></div>
  
  <div class="controls">
    <button onclick="refreshLogs()">üîÑ Refresh</button>
    <button onclick="clearLogs()">üóëÔ∏è Clear</button>
    <button onclick="toggleAutoRefresh()" id="autoRefreshBtn">‚è∏Ô∏è Stop Auto-refresh</button>
  </div>

  <script>
    const logsEl = document.getElementById('logs');
    const statusEl = document.getElementById('status');
    const autoRefreshBtn = document.getElementById('autoRefreshBtn');
    
    // Get backend URL from config
    const getBackendUrl = () => {
      if (window.CONFIG?.BACKEND_URL) {
        return window.CONFIG.BACKEND_URL;
      }
      // Fallback to current host
      return `${window.location.protocol}//${window.location.hostname}:4000`;
    };
    
    let autoRefreshInterval = null;
    let isAutoRefreshing = true;
    let lastLogContent = '';
    
    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = message;
      logsEl.appendChild(entry);
      logsEl.scrollTop = logsEl.scrollHeight;
    }
    
    function clearLogs() {
      logsEl.innerHTML = '';
      addLog('üóëÔ∏è  Logs cleared', 'info');
    }
    
    function updateStatus(message, connected = true) {
      statusEl.textContent = message;
      statusEl.className = connected ? 'status connected' : 'status disconnected';
    }
    
    async function fetchLogs() {
      try {
        const response = await fetch(`${getBackendUrl()}/api/kiro-live-log`);
        const data = await response.json();
        
        if (response.ok && data.content !== undefined) {
          // Only update if content changed
          if (data.content !== lastLogContent) {
            lastLogContent = data.content;
            displayLogContent(data.content);
          }
          updateStatus('‚úÖ Connected - Live log streaming', true);
        } else {
          updateStatus('‚ùå Error fetching logs', false);
          addLog(`‚ùå Error: ${data.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        updateStatus('‚ùå Connection failed', false);
        addLog(`‚ùå Connection error: ${error.message}`, 'error');
      }
    }
    
    function displayLogContent(content) {
      logsEl.innerHTML = '';
      
      if (!content.trim()) {
        addLog('üìù Log file is empty', 'info');
        return;
      }
      
      const lines = content.split('\n');
      lines.forEach(line => {
        if (line.trim()) {
          // Determine log type from line content
          let type = 'info';
          if (line.includes('‚úÖ') || line.includes('SUCCESS')) type = 'success';
          else if (line.includes('‚ùå') || line.includes('ERROR')) type = 'error';
          else if (line.includes('‚ö†Ô∏è') || line.includes('WARNING')) type = 'warning';
          
          const entry = document.createElement('div');
          entry.className = `log-entry ${type}`;
          entry.textContent = line;
          logsEl.appendChild(entry);
        }
      });
      
      logsEl.scrollTop = logsEl.scrollHeight;
    }
    
    function refreshLogs() {
      fetchLogs();
    }
    
    function toggleAutoRefresh() {
      if (isAutoRefreshing) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        isAutoRefreshing = false;
        autoRefreshBtn.textContent = '‚ñ∂Ô∏è Start Auto-refresh';
        updateStatus('‚è∏Ô∏è Auto-refresh paused', true);
      } else {
        startAutoRefresh();
        isAutoRefreshing = true;
        autoRefreshBtn.textContent = '‚è∏Ô∏è Stop Auto-refresh';
      }
    }
    
    function startAutoRefresh() {
      autoRefreshInterval = setInterval(fetchLogs, 1000); // Refresh every second
    }
    
    // Initialize
    addLog('üöÄ Kiro Live Terminal', 'success');
    addLog('üì° Connecting to backend...', 'info');
    addLog('', 'info');
    addLog('This terminal shows live content from:', 'info');
    addLog('  ‚Ä¢ /tmp/kiro-cli-live.log', 'info');
    addLog('  ‚Ä¢ Updates every 1 second', 'info');
    addLog('', 'info');
    
    // Start fetching logs
    fetchLogs();
    startAutoRefresh();
  </script>
</body>
</html>
