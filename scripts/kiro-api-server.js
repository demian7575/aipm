#!/usr/bin/env node

import http from 'http';
import { spawn } from 'child_process';

const server = http.createServer(async (req, res) => {
  // CORS headers
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    res.writeHead(200);
    res.end();
    return;
  }

  if (req.url === '/health') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ 
      status: 'running',
      service: 'kiro-api-server',
      port: 8083,
      uptime: process.uptime()
    }));
    return;
  }

  if (req.url === '/kiro/enhance-story' && req.method === 'POST') {
    let body = '';
    req.on('data', chunk => body += chunk);
    req.on('end', async () => {
      try {
        const { idea, draft, parent, prompt } = JSON.parse(body);
        
        console.log('ðŸ“ Enhancing story with Kiro CLI:', idea);
        
        const result = await generateCodeWithKiroCLI(prompt, `story-enhancement-${Date.now()}`);
        
        // For now, return enhanced version of the draft
        // TODO: Parse Kiro's actual response to extract enhanced fields
        const enhanced = {
          title: draft.title,
          description: `Enhanced: ${draft.description}`,
          asA: draft.asA,
          iWant: draft.iWant,
          soThat: `${draft.soThat} (Enhanced by Kiro)`,
          acceptanceCriteria: [
            ...draft.acceptanceCriteria,
            'Enhanced with Kiro CLI feedback'
          ]
        };
        
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify(enhanced));
      } catch (error) {
        console.error('Story enhancement error:', error);
        res.writeHead(500, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: error.message }));
      }
    });
    return;
  }

  if (req.url === '/kiro/generate-code' && req.method === 'POST') {
    let body = '';
    req.on('data', chunk => body += chunk);
    req.on('end', async () => {
      try {
        const { taskTitle, objective, constraints, acceptanceCriteria } = JSON.parse(body);
        
        // Use Kiro CLI to generate code
        const prompt = `Generate code for this task:

Title: ${taskTitle}
Objective: ${objective}
Constraints: ${constraints}
Acceptance Criteria:
${acceptanceCriteria.map(c => `- ${c}`).join('\n')}

Project context: AIPM is a vanilla JavaScript project with Express backend.
Generate minimal, working code. Return only the code without explanations.`;

        const result = await generateCodeWithKiroCLI(prompt, taskTitle);
        
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify(result));
      } catch (error) {
        console.error('Code generation error:', error);
        res.writeHead(500, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ 
          error: error.message,
          files: [{
            path: `${taskTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-')}.js`,
            content: `// ${taskTitle}\n// TODO: Implement ${objective}\n\nfunction ${taskTitle.toLowerCase().replace(/[^a-z0-9]+/g, '')}() {\n  return 'Not implemented';\n}\n\nexport default ${taskTitle.toLowerCase().replace(/[^a-z0-9]+/g, '')};`
          }],
          summary: `Fallback implementation for: ${taskTitle}`
        }));
      }
    });
    return;
  }

  res.writeHead(404, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({ error: 'Not found' }));
});

async function generateCodeWithKiroCLI(prompt, taskTitle) {
  return new Promise((resolve, reject) => {
    const kiro = spawn('kiro-cli', ['chat'], {
      stdio: ['pipe', 'pipe', 'pipe']
    });

    let output = '';
    let error = '';

    kiro.stdout.on('data', (data) => {
      output += data.toString();
    });

    kiro.stderr.on('data', (data) => {
      error += data.toString();
    });

    kiro.on('close', (code) => {
      if (code !== 0) {
        reject(new Error(`Kiro CLI failed: ${error}`));
        return;
      }

      // Extract code from Kiro output
      const codeMatch = output.match(/```(?:javascript|js)?\n([\s\S]*?)\n```/);
      const generatedCode = codeMatch ? codeMatch[1] : `// ${taskTitle}\n// Generated by Kiro CLI\n\n// TODO: Implement functionality`;

      resolve({
        files: [{
          path: `${taskTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-')}.js`,
          content: generatedCode
        }],
        summary: `Code generated by Kiro CLI for: ${taskTitle}`,
        rawOutput: output
      });
    });

    // Send prompt to Kiro CLI
    kiro.stdin.write(prompt + '\n');
    kiro.stdin.end();

    // Timeout after 60 seconds
    setTimeout(() => {
      kiro.kill();
      reject(new Error('Kiro CLI timeout'));
    }, 60000);
  });
}

const PORT = 8083;
server.listen(PORT, '0.0.0.0', () => {
  console.log(`Kiro API Server running on port ${PORT}`);
});

process.on('SIGTERM', () => {
  console.log('Received SIGTERM, shutting down gracefully');
  server.close(() => {
    process.exit(0);
  });
});
