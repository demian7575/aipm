#!/bin/bash
# Weekly Full Validation Suite
# Complete end-to-end testing including user journeys

set -e
source "$(dirname "$0")/test-library.sh"

# Configuration
API_BASE="${API_BASE:-http://44.220.45.57:4000}"
KIRO_API_BASE="${KIRO_API_BASE:-http://44.220.45.57:8081}"
FRONTEND_URL="${FRONTEND_URL:-http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com}"
TARGET_ENV="${TARGET_ENV:-prod}"

echo "ğŸ“† Weekly Full Validation - $(date)"
echo "Environment: $TARGET_ENV"
echo ""

# Phase 1: Security & Data Safety
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”´ Phase 1: Security & Data Safety"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
test_api_security_headers "$API_BASE"
test_database_connection "$API_BASE"
test_version_endpoint "$API_BASE"

# Phase 2: Performance & API
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸŸ¡ Phase 2: Performance & API"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
test_api_response_time "$API_BASE" 5
test_kiro_api_health "$KIRO_API_BASE"
test_draft_generation_performance "$KIRO_API_BASE"

# Phase 3: Infrastructure
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸŸ¢ Phase 3: Infrastructure"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
test_frontend_availability "$FRONTEND_URL"
test_s3_config "$FRONTEND_URL" "$TARGET_ENV"
test_network_connectivity "$API_BASE"

# Phase 4: Workflows
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”„ Phase 4: Workflows"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
test_story_crud "$API_BASE"
test_invest_analysis "$API_BASE" "$KIRO_API_BASE"
test_health_check "$API_BASE"
test_code_generation_endpoint "$KIRO_API_BASE"

# Phase 5: End-to-End Journey
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¯ Phase 5: End-to-End Journey"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
test_complete_user_journey "$API_BASE"

# Deployment Verification
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Deployment Verification"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
test_deployment_health "$API_BASE" "$FRONTEND_URL"
test_version_consistency "$API_BASE"

# Final Summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Weekly Validation Summary"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Passed: $PHASE_PASSED"
echo "âŒ Failed: $PHASE_FAILED"
echo "ğŸ“ˆ Total: $((PHASE_PASSED + PHASE_FAILED))"
echo "ğŸ“… Date: $(date)"
echo "ğŸŒ Environment: $TARGET_ENV"

if [[ $PHASE_FAILED -eq 0 ]]; then
    echo ""
    echo "âœ… Weekly validation PASSED - System fully operational"
    exit 0
else
    echo ""
    echo "âš ï¸ Weekly validation FAILED - $PHASE_FAILED issues require immediate attention"
    exit 1
fi
