version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - node -v
        build:
          commands:
            - |
              set -euxo pipefail

              # 1) 스테이징 디렉토리
              rm -rf .amplify-hosting
              mkdir -p .amplify-hosting/static
              mkdir -p .amplify-hosting/compute/default/apps

              # 2) 정적(동일 오리진)
              cp -R apps/frontend/public/* .amplify-hosting/static/
              printf "window.__AIPM_API_BASE__ = '';\n" > .amplify-hosting/static/config.js

              # 3) Compute 번들 (상대 import 유지 위해 폴더 단위 복사)
              cp -R apps/backend .amplify-hosting/compute/default/apps/
              cp server.js .amplify-hosting/compute/default/server.js

              # 4) 런타임 엔트리포인트 (포트 3000, /tmp 실행, /api/health 포함)
              cat > .amplify-hosting/compute/default/server-backend.js <<'JS'
              process.env.AI_PM_FORCE_JSON_DB = '1';
              process.env.AI_PM_DISABLE_OPENAI = '1';

              import { mkdir, readFile, writeFile } from 'node:fs/promises';
              import path from 'node:path';

              const TMP_ROOT = '/tmp/aipm';
              const TMP_BACKEND = path.join(TMP_ROOT, 'apps', 'backend');
              await mkdir(TMP_BACKEND, { recursive: true });

              const appSrc = await readFile('./apps/backend/app.js', 'utf8');
              const rootServerSrc = await readFile('./server.js', 'utf8');
              await writeFile(path.join(TMP_BACKEND, 'app.js'), appSrc, 'utf8');
              await writeFile(path.join(TMP_ROOT, 'server.js'), rootServerSrc, 'utf8');

              const { createApp } = await import('file:///tmp/aipm/apps/backend/app.js');
              const server = await createApp();

              server.prependListener('request', (req, res) => {
                try {
                  const url = new URL(req.url || '/', 'http://localhost');
                  console.log('[REQ]', new Date().toISOString(), req.method, url.pathname);
                  if (url.pathname === '/api/health') {
                    res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
                    res.end(JSON.stringify({ ok: true, now: new Date().toISOString() }));
                    return;
                  }
                } catch {}
              });

              server.listen(3000, () => console.log('[BOOT] listening on 3000'));
              JS

              # 5) 레포의 manifest 그대로 사용 (콜론 포함해도 문제 없음)
              test -f deploy-manifest.json || (echo 'ERROR: deploy-manifest.json not found at repo root' && exit 3)
              cp deploy-manifest.json .amplify-hosting/deploy-manifest.json

              # 6) 검증 로그
              echo '== Compute bundle =='
              ls -R .amplify-hosting/compute/default
              echo '== Manifest preview =='
              head -n 50 .amplify-hosting/deploy-manifest.json
      artifacts:
        baseDirectory: .amplify-hosting/static
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*

