version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - node -v
        build:
          commands:
            # 스테이징 디렉토리
            - rm -rf .amplify-hosting
            - mkdir -p .amplify-hosting/static
            - mkdir -p .amplify-hosting/compute/default

            # 정적 (동일 오리진)
            - cp -R apps/frontend/public/* .amplify-hosting/static/
            - printf "window.__AIPM_API_BASE__ = '';\n" > .amplify-hosting/static/config.js

            # Compute 번들: 백엔드 전체 + 루트 server.js
            - cp -R apps/backend .amplify-hosting/compute/default/apps/backend
            - cp server.js .amplify-hosting/compute/default/server.js

            # 엔트리포인트(포트 3000에서 실행 + /tmp로 복사하여 쓰기경로 확보)
            - |
              cat > .amplify-hosting/compute/default/server-backend.js <<'JS'
              import { mkdir, readFile, writeFile } from 'node:fs/promises';
              import path from 'node:path';
              process.env.AI_PM_FORCE_JSON_DB = '1';   // sqlite 없이 JSON DB 사용
              process.env.AI_PM_DISABLE_OPENAI = '1';  // 외부 호출 비활성 (원하면 제거)

              const TMP_ROOT = '/tmp/aipm';
              const TMP_BACKEND = path.join(TMP_ROOT, 'apps', 'backend');
              await mkdir(TMP_BACKEND, { recursive: true });

              // 원본을 /tmp로 복사(../../server.js 상대경로를 /tmp 기준으로 성립시킴)
              const appSrc = await readFile('./apps/backend/app.js', 'utf8');
              const rootServerSrc = await readFile('./server.js', 'utf8');
              await writeFile(path.join(TMP_BACKEND, 'app.js'), appSrc, 'utf8');
              await writeFile(path.join(TMP_ROOT, 'server.js'), rootServerSrc, 'utf8');

              // /tmp에서 백엔드 실행 (데이터/업로드가 /tmp 하위에 생성됨)
              const { createApp } = await import('file:///tmp/aipm/apps/backend/app.js');
              const server = await createApp();
              server.listen(3000, () => console.log('[AIPM] listening on 3000'));
              JS

            # 레포의 manifest를 빌드 출력 위치로 복사 (스키마 검증 대상)
            - cp deploy-manifest.json .amplify-hosting/deploy-manifest.json

            # 디버그 출력
            - ls -R .amplify-hosting
      artifacts:
        baseDirectory: .amplify-hosting/static
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*

