version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - set -euxo pipefail
            - node -v
        build:
          commands:
            # 1) 스테이징 디렉토리 생성
            - rm -rf .amplify-hosting
            - mkdir -p .amplify-hosting/static
            - mkdir -p .amplify-hosting/compute/default/apps   # ✅ apps까지 미리 생성

            # 2) 정적 파일 (동일 오리진)
            - cp -R apps/frontend/public/* .amplify-hosting/static/
            - printf "window.__AIPM_API_BASE__ = '';\n" > .amplify-hosting/static/config.js

            # 3) Compute 번들: 백엔드 전체 + 루트 server.js
            - cp -R apps/backend .amplify-hosting/compute/default/apps/   # ✅ 상위 폴더가 있으니 성공
            - cp server.js .amplify-hosting/compute/default/server.js

            # 4) 런타임 래퍼: /tmp에서 실행(쓰기 가능), JSON DB 강제, 포트 3000, 헬스체크 추가
            - |
              cat > .amplify-hosting/compute/default/server-backend.js <<'JS'
              process.env.AI_PM_FORCE_JSON_DB = '1';   // sqlite 불요
              process.env.AI_PM_DISABLE_OPENAI = '1';  // 외부 호출 비활성(원하면 제거)

              import { mkdir, readFile, writeFile } from 'node:fs/promises';
              import path from 'node:path';

              const TMP_ROOT = '/tmp/aipm';
              const TMP_BACKEND = path.join(TMP_ROOT, 'apps', 'backend');
              await mkdir(TMP_BACKEND, { recursive: true });

              // 원본을 /tmp로 복사(../../server.js 상대경로 유지)
              const appSrc = await readFile('./apps/backend/app.js', 'utf8');
              const rootServerSrc = await readFile('./server.js', 'utf8');
              await writeFile(path.join(TMP_BACKEND, 'app.js'), appSrc, 'utf8');
              await writeFile(path.join(TMP_ROOT, 'server.js'), rootServerSrc, 'utf8');

              // /tmp에서 백엔드 로드
              const { createApp } = await import('file:///tmp/aipm/apps/backend/app.js');
              const server = await createApp();

              // 진단용 /api/health (요청 로깅 포함)
              server.prependListener('request', (req, res) => {
                try {
                  const url = new URL(req.url || '/', 'http://localhost');
                  console.log('[REQ]', new Date().toISOString(), req.method, url.pathname);
                  if (url.pathname === '/api/health') {
                    res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
                    res.end(JSON.stringify({ ok: true, now: new Date().toISOString() }));
                    return;
                  }
                } catch {}
              });

              // 포트 3000 리슨(Amplify Compute 규정)
              server.listen(3000, () => console.log('[BOOT] listening on 3000'));
              JS

            # 5) 매니페스트: 레포에 파일이 있으면 복사, 없으면 생성
            - |
              if [ -f deploy-manifest.json ]; then
                cp deploy-manifest.json .amplify-hosting/deploy-manifest.json
              else
                cat > .amplify-hosting/deploy-manifest.json <<'JSON'
                {
                  "version": 1,
                  "routes": [
                    { "path": "/api/*", "target": { "kind": "Compute", "src": "default" } },
                    { "path": "/*",     "target": { "kind": "Static" } }
                  ],
                  "computeResources": [
                    { "name": "default", "entrypoint": "server-backend.js", "runtime": "nodejs22.x" }
                  ],
                  "framework": { "name": "custom", "version": "1.0.0" }
                }
                JSON
              fi

            # 6) 검증 로그
            - ls -R .amplify-hosting/compute/default
      artifacts:
        baseDirectory: .amplify-hosting/static
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*

