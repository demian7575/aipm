version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - node -v
        build:
          commands:
            - |
              set -euxo pipefail

              # 1) ìŠ¤í…Œì´ì§• ë””ë ‰í† ë¦¬
              rm -rf .amplify-hosting
              mkdir -p .amplify-hosting/static
              mkdir -p .amplify-hosting/compute/default/apps

              # 2) ì •ì (ë™ì¼ ì˜¤ë¦¬ì§„)
              cp -R apps/frontend/public/* .amplify-hosting/static/
              printf "window.__AIPM_API_BASE__ = '';\n" > .amplify-hosting/static/config.js

              # 3) Compute ë²ˆë“¤(í´ë” ë‹¨ìœ„ ë³µì‚¬ë¡œ ìƒëŒ€ import ìœ ì§€)
              cp -R apps/backend .amplify-hosting/compute/default/apps/
              cp server.js .amplify-hosting/compute/default/server.js

              # 4) ëŸ°íƒ€ì„ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
              #   - /tmpë¡œ ë³µì‚¬í•´ ì“°ê¸° ê²½ë¡œ í™•ë³´
              #   - JSON DB ê°•ì œ
              #   - _writeSqliteMirror()ë¥¼ no-opìœ¼ë¡œ íŒ¨ì¹˜(Amplifyì—” python3 ì—†ìŒ)
              cat > .amplify-hosting/compute/default/server-backend.js <<'JS'
              process.env.AI_PM_FORCE_JSON_DB = '1';
              process.env.AI_PM_DISABLE_OPENAI = '1';

              import { mkdir, readFile, writeFile } from 'node:fs/promises';
              import path from 'node:path';

              const TMP_ROOT = '/tmp/aipm';
              const TMP_BACKEND = path.join(TMP_ROOT, 'apps', 'backend');
              await mkdir(TMP_BACKEND, { recursive: true });

              // ì›ë³¸ app.js ì½ê¸°
              let appSrc = await readFile('./apps/backend/app.js', 'utf8');

              // ğŸ”§ sqlite ë¯¸ëŸ¬ë§ ì™„ì „ ë¹„í™œì„±í™” (python3 ENOENT ë°©ì§€)
              appSrc = appSrc.replace(
                /_writeSqliteMirror\\(\\)\\s*\\{[\\s\\S]*?\\}/,
                `_writeSqliteMirror() { /* disabled on Amplify */ return; }`
              );

              // /tmpì— ê¸°ë¡(../../server.js ìƒëŒ€ê²½ë¡œë¥¼ /tmp ê¸°ì¤€ìœ¼ë¡œ ì„±ë¦½)
              const rootServerSrc = await readFile('./server.js', 'utf8');
              await writeFile(path.join(TMP_BACKEND, 'app.js'), appSrc, 'utf8');
              await writeFile(path.join(TMP_ROOT, 'server.js'), rootServerSrc, 'utf8');

              // ë°±ì—”ë“œ ë¡œë“œ
              const { createApp } = await import('file:///tmp/aipm/apps/backend/app.js');
              const server = await createApp();

              // ê°„ë‹¨ í—¬ìŠ¤ì—”ë“œí¬ì¸íŠ¸/ìš”ì²­ë¡œê·¸(ì§„ë‹¨ìš©)
              server.prependListener('request', (req, res) => {
                try {
                  const url = new URL(req.url || '/', 'http://localhost');
                  console.log('[REQ]', new Date().toISOString(), req.method, url.pathname);
                  if (url.pathname === '/api/health') {
                    res.writeHead(200, { 'Content-Type': 'application/json; charset=utf-8' });
                    res.end(JSON.stringify({ ok: true, now: new Date().toISOString() }));
                    return;
                  }
                } catch {}
              });

              server.listen(3000, () => console.log('[BOOT] listening on 3000'));
              JS

              # 5) ë ˆí¬ì— ìˆëŠ” manifest ê·¸ëŒ€ë¡œ ì‚¬ìš©
              test -f deploy-manifest.json || (echo 'ERROR: deploy-manifest.json not found at repo root' && exit 3)
              cp deploy-manifest.json .amplify-hosting/deploy-manifest.json

              # 6) ê²€ì¦ ë¡œê·¸
              echo '== Compute bundle =='; ls -R .amplify-hosting/compute/default
              echo '== Manifest preview =='; head -n 40 .amplify-hosting/deploy-manifest.json
      artifacts:
        baseDirectory: .amplify-hosting/static
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*

