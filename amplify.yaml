version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - nvm use 22 || true
            - node -v
        build:
          commands:
            - rm -rf .amplify-hosting
            - mkdir -p .amplify-hosting/static
            - mkdir -p .amplify-hosting/compute/default

            # Static 산출물
            - cp -R apps/frontend/public/* .amplify-hosting/static/
            - printf "window.__AIPM_API_BASE__ = '';\n" > .amplify-hosting/static/config.js

            # ✅ Compute: 'server.js'와 'app.js'를 루트로 복사 (중요!)
            - cp apps/backend/server.js .amplify-hosting/compute/default/server.js
            - cp apps/backend/app.js    .amplify-hosting/compute/default/app.js

            # 매니페스트 복사
            - cp deploy-manifest.json .amplify-hosting/deploy-manifest.json

            # 검증 로그
            - echo "----- compute root -----"
            - ls -la .amplify-hosting/compute/default
            - echo "----- manifest -----"
            - cat .amplify-hosting/deploy-manifest.json
      artifacts:
        baseDirectory: .amplify-hosting
        files:
          - '**/*'

