name: Deploy PR to Development

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: development
    
    steps:
      - name: Get PR branch name
        id: pr-info
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          echo "ğŸ“¥ Getting info for PR #$PR_NUMBER"
          
          # Get branch name from PR
          BRANCH_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | jq -r '.head.ref')
          
          if [[ -z "$BRANCH_NAME" || "$BRANCH_NAME" == "null" ]]; then
            echo "âŒ Failed to get branch name for PR #$PR_NUMBER"
            exit 1
          fi
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "âœ… PR branch: $BRANCH_NAME"
      
      - name: Checkout PR branch directly
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.pr-info.outputs.branch_name }}
          fetch-depth: 0
      
      - name: Rebase onto latest main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="${{ steps.pr-info.outputs.branch_name }}"
          echo "ğŸ“ Current branch: $(git branch --show-current)"
          echo "ğŸ“ Current commit: $(git rev-parse --short HEAD)"
          
          # Rebase onto latest main
          echo "ğŸ”„ Rebasing onto latest main..."
          git fetch origin main
          git rebase origin/main
          
          if [ $? -ne 0 ]; then
            echo "âŒ Rebase failed - PR has conflicts with main"
            echo "Please update your PR branch and resolve conflicts first"
            git rebase --abort
            exit 1
          fi
          
          echo "âœ… PR branch rebased onto latest main"
          
          # Push rebased branch back to GitHub
          echo "ğŸ“¤ Pushing rebased branch to GitHub..."
          git push origin HEAD:$BRANCH_NAME --force-with-lease
          echo "âœ… Rebased branch pushed to GitHub"
          
          # Verify we're deploying the rebased code
          echo "ğŸ” Verifying deployment source..."
          CURRENT_BRANCH=$(git branch --show-current)
          CURRENT_COMMIT=$(git rev-parse --short HEAD)
          MAIN_COMMIT=$(git rev-parse --short origin/main)
          PR_CHANGES=$(git diff --name-only origin/main | wc -l)
          
          echo "ğŸ“Š Current branch: $CURRENT_BRANCH"
          echo "ğŸ“Š Current commit: $CURRENT_COMMIT"
          echo "ğŸ“Š Main commit: $MAIN_COMMIT"
          echo "ğŸ“Š PR changes: $PR_CHANGES files"
          
          # Verify we're on the correct branch
          if [[ "$CURRENT_BRANCH" != "$BRANCH_NAME" ]]; then
            echo "âŒ ERROR: Not on PR branch!"
            echo "   Expected: $BRANCH_NAME"
            echo "   Actual: $CURRENT_BRANCH"
            exit 1
          fi
          
          # List changed files for verification
          if [ "$PR_CHANGES" -gt 0 ]; then
            echo "ğŸ“ Files changed in PR:"
            git diff --name-only origin/main | head -10
          fi
      
      - name: Run critical gating tests
        run: |
          echo "ğŸ§ª Running critical gating tests..."
          
          # Test 1: JavaScript syntax check
          echo "  1ï¸âƒ£ Checking JavaScript syntax..."
          if [ -f "apps/frontend/public/app.js" ]; then
            if ! node -c apps/frontend/public/app.js; then
              echo "âŒ Syntax error in app.js"
              exit 1
            fi
            echo "  âœ… app.js syntax OK"
          fi
          
          # Test 2: Brace balance check
          echo "  2ï¸âƒ£ Checking brace balance..."
          if [ -f "apps/frontend/public/app.js" ]; then
            OPEN=$(grep -o '{' apps/frontend/public/app.js | wc -l)
            CLOSE=$(grep -o '}' apps/frontend/public/app.js | wc -l)
            if [ "$OPEN" -ne "$CLOSE" ]; then
              echo "âŒ Unbalanced braces: Open=$OPEN, Close=$CLOSE"
              exit 1
            fi
            echo "  âœ… Braces balanced ($OPEN pairs)"
          fi
          
          # Test 3: Backend syntax check
          echo "  3ï¸âƒ£ Checking backend syntax..."
          if [ -f "apps/backend/app.js" ]; then
            if ! node -c apps/backend/app.js; then
              echo "âŒ Syntax error in backend app.js"
              exit 1
            fi
            echo "  âœ… Backend syntax OK"
          fi
          
          # Test 4: No console.log in production code (warning only)
          echo "  4ï¸âƒ£ Checking for debug statements..."
          if git diff origin/main apps/frontend/public/app.js | grep -E "^\+.*console\.(log|debug)" > /dev/null; then
            echo "  âš ï¸  Warning: New console.log statements found"
            echo "     Consider removing before production"
          else
            echo "  âœ… No new debug statements"
          fi
          
          echo "âœ… Critical gating tests passed"
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Setup SSH key for deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          # Try base64 decode first, fallback to raw key
          if echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
            echo "âœ… Decoded base64 SSH key"
          else
            echo "ğŸ“ Using raw SSH key"
            printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          fi
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 44.222.168.46 >> ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1 && echo "âœ… SSH key configured" || (echo "âŒ SSH key validation failed" && exit 1)
      
      - name: Create development config
        run: |
          echo "ğŸ“ Creating development configuration..."
          cat > apps/frontend/public/config.js << EOF
          window.CONFIG = {
            API_BASE_URL: 'http://44.222.168.46:4000',
            EC2_TERMINAL_URL: 'ws://44.222.168.46:8080',
            GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}',
            PROD_VERSION: '4.0.0-dev',
            ENVIRONMENT: 'development',
            environment: 'development',
            stage: 'dev',
            region: 'us-east-1',
            storiesTable: 'aipm-backend-dev-stories',
            acceptanceTestsTable: 'aipm-backend-dev-acceptance-tests',
            DEBUG: true
          };
          EOF
          
          echo "âœ… Development config created"
      
      - name: Deploy backend to development EC2
        run: |
          echo "ğŸš€ Deploying backend to development EC2..."
          ./scripts/deploy-to-environment.sh dev
          
          echo "âœ… Backend deployed to development EC2"
      
      - name: Sync database from production to development
        run: |
          echo "ğŸ”„ Syncing database from production to development..."
          node scripts/utilities/sync-prod-to-dev.cjs
          echo "âœ… Database synced"
      
      - name: Deploy frontend to S3
        run: |
          echo "ğŸš€ Deploying frontend to S3..."
          
          # Copy dev config
          echo "ğŸ“ Copying dev configuration..."
          cp config/config.dev.js apps/frontend/public/config.js
          
          # Verify we're deploying the correct version
          echo "ğŸ” Pre-deployment verification..."
          echo "ğŸ“Š Current git commit: $(git rev-parse --short HEAD)"
          echo "ğŸ“Š app.js first line: $(head -1 apps/frontend/public/app.js)"
          echo "ğŸ“Š app.js size: $(wc -c < apps/frontend/public/app.js) bytes"
          echo "ğŸ“Š app.js lines: $(wc -l < apps/frontend/public/app.js) lines"
          
          # Force upload all files (don't rely on size/time comparison)
          echo "ğŸ”„ Uploading all files..."
          for file in apps/frontend/public/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "  Uploading $filename..."
              aws s3 cp "$file" "s3://aipm-dev-frontend-hosting/$filename" \
                --cache-control "no-cache, no-store, must-revalidate" \
                --region us-east-1
            fi
          done
          
          # Upload subdirectories if any
          if [ -d "apps/frontend/public/uploads" ]; then
            aws s3 sync apps/frontend/public/uploads/ s3://aipm-dev-frontend-hosting/uploads/ \
              --cache-control "no-cache, no-store, must-revalidate" \
              --delete \
              --region us-east-1
          fi
          
          echo "âœ… Frontend deployed to S3"
          echo "ğŸŒ Development URL: http://aipm-dev-frontend-hosting.s3-website-us-east-1.amazonaws.com"
          
          # Verify deployment
          echo "ğŸ” Post-deployment verification..."
          sleep 2
          S3_SIZE=$(aws s3api head-object --bucket aipm-dev-frontend-hosting --key app.js --region us-east-1 | jq -r '.ContentLength')
          LOCAL_SIZE=$(wc -c < apps/frontend/public/app.js)
          echo "ğŸ“Š S3 app.js size: $S3_SIZE bytes"
          echo "ğŸ“Š Local app.js size: $LOCAL_SIZE bytes"
          
          if [ "$S3_SIZE" = "$LOCAL_SIZE" ]; then
            echo "âœ… Deployment verified - sizes match"
          else
            echo "âŒ ERROR: Size mismatch!"
            echo "   S3: $S3_SIZE bytes"
            echo "   Local: $LOCAL_SIZE bytes"
            exit 1
          fi
      
      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          
          # Check backend health
          if curl -sf http://44.222.168.46:4000/health | jq -e '.status == "running"' > /dev/null; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
            exit 1
          fi
          
          echo "âœ… Deployment verified successfully"
