name: Deploy PR to Development

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: development
    
    steps:
      - name: Get PR branch name
        id: pr-info
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          echo "ðŸ“¥ Getting info for PR #$PR_NUMBER"
          
          # Get branch name from PR
          BRANCH_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | jq -r '.head.ref')
          
          if [[ -z "$BRANCH_NAME" || "$BRANCH_NAME" == "null" ]]; then
            echo "âŒ Failed to get branch name for PR #$PR_NUMBER"
            exit 1
          fi
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "âœ… PR branch: $BRANCH_NAME"
      
      - name: Checkout PR branch directly
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.pr-info.outputs.branch_name }}
          fetch-depth: 0
      
      - name: Rebase onto latest main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="${{ steps.pr-info.outputs.branch_name }}"
          echo "ðŸ“ Current branch: $(git branch --show-current)"
          echo "ðŸ“ Current commit: $(git rev-parse --short HEAD)"
          
          # Ensure we're on the branch (not detached HEAD)
          git checkout -B $BRANCH_NAME
          echo "âœ… On branch: $(git branch --show-current)"
          
          # Rebase onto latest main
          echo "ðŸ”„ Rebasing onto latest main..."
          git fetch origin main
          git rebase origin/main
          
          if [ $? -ne 0 ]; then
            echo "âŒ Rebase failed - PR has conflicts with main"
            echo "Please update your PR branch and resolve conflicts first"
            git rebase --abort
            exit 1
          fi
          
          echo "âœ… PR branch rebased onto latest main"
          
          # Push rebased branch back to GitHub
          echo "ðŸ“¤ Pushing rebased branch to GitHub..."
          git push origin $BRANCH_NAME --force-with-lease
          echo "âœ… Rebased branch pushed to GitHub"
          
          # Verify we're deploying the rebased code
          echo "ðŸ” Verifying deployment source..."
          CURRENT_BRANCH=$(git branch --show-current)
          CURRENT_COMMIT=$(git rev-parse --short HEAD)
          MAIN_COMMIT=$(git rev-parse --short origin/main)
          PR_CHANGES=$(git diff --name-only origin/main | wc -l)
          
          echo "ðŸ“Š Current branch: $CURRENT_BRANCH"
          echo "ðŸ“Š Current commit: $CURRENT_COMMIT"
          echo "ðŸ“Š Main commit: $MAIN_COMMIT"
          echo "ðŸ“Š PR changes: $PR_CHANGES files"
          
          # Verify we're on the correct branch
          if [[ "$CURRENT_BRANCH" != "$BRANCH_NAME" ]]; then
            echo "âŒ ERROR: Not on PR branch!"
            echo "   Expected: $BRANCH_NAME"
            echo "   Actual: $CURRENT_BRANCH"
            exit 1
          fi
          
          # List changed files for verification
          if [ "$PR_CHANGES" -gt 0 ]; then
            echo "ðŸ“ Files changed in PR:"
            git diff --name-only origin/main | head -10
          fi
      
      - name: Load Development environment configuration
        run: |
          source scripts/utilities/load-env-config.sh dev
          echo "DEV_EC2_IP=$EC2_IP" >> $GITHUB_ENV
          echo "DEV_API_BASE=$API_BASE" >> $GITHUB_ENV
          echo "DEV_SEMANTIC_API_BASE=$SEMANTIC_API_BASE" >> $GITHUB_ENV
          echo "DEV_S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          echo "DEV_TERMINAL_URL=$TERMINAL_URL" >> $GITHUB_ENV
          echo "DEV_DYNAMODB_STORIES_TABLE=$DYNAMODB_STORIES_TABLE" >> $GITHUB_ENV
          echo "DEV_DYNAMODB_TESTS_TABLE=$DYNAMODB_TESTS_TABLE" >> $GITHUB_ENV
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps
          sudo apt-get update
          sudo apt-get install -y jq python3-yaml
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Setup SSH key for deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          if echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
            echo "âœ… Decoded base64 SSH key"
          else
            echo "ðŸ“ Using raw SSH key"
            printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          fi
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $DEV_EC2_IP >> ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1 && echo "âœ… SSH key configured" || (echo "âŒ SSH key validation failed" && exit 1)
      
      - name: Deploy backend to development EC2
        run: |
          echo "ðŸš€ Deploying backend to development EC2..."
          ./scripts/deploy-to-environment.sh dev
          echo "âœ… Backend deployed to development EC2"
      
      - name: Deploy frontend to development S3
        run: |
          echo "ðŸ“¦ Deploying frontend to development S3..."
          
          # Create dev config
          cat > apps/frontend/public/config.js << EOF
          window.CONFIG = {
            API_BASE_URL: '${{ env.DEV_API_BASE }}',
            EC2_TERMINAL_URL: '${{ env.DEV_TERMINAL_URL }}',
            ENVIRONMENT: 'dev'
          };
          EOF
          
          aws s3 sync apps/frontend/public/ s3://${{ env.DEV_S3_BUCKET }} --delete --cache-control no-cache
          echo "âœ… Frontend deployed to development S3"
      
      - name: Run Pre-Production Gating Tests
        id: gating
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_ENV: dev
          API_BASE: ${{ env.DEV_API_BASE }}
          SEMANTIC_API_BASE: ${{ env.DEV_SEMANTIC_API_BASE }}
          SSH_HOST: ${{ env.DEV_EC2_IP }}
          SKIP_GATING_TESTS: true
        run: |
          echo "ðŸ§ª Running Gating Tests on Development Environment"
          echo "   Backend: $API_BASE"
          echo "   Database: Development DynamoDB"
          
          # Wait for deployment to be ready
          sleep 10
          
          # Run Phase 1 (Security & Data Safety) and Phase 2 (E2E Workflow)
          if ./scripts/testing/run-structured-gating-tests.sh --phases "1,2"; then
            echo "âœ… Gating tests passed - PR validated"
          else
            echo "âŒ Gating tests failed - PR has issues"
            exit 1
          fi
