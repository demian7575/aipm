name: Deploy PR to Development

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: development
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Checkout PR branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          echo "ğŸ“¥ Deploying PR #$PR_NUMBER"
          
          # Get branch name from PR
          BRANCH_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | jq -r '.head.ref')
          
          echo "Branch: $BRANCH_NAME"
          
          # Checkout PR branch
          git fetch origin $BRANCH_NAME
          git checkout $BRANCH_NAME
          
          # Rebase onto latest main
          echo "ğŸ”„ Rebasing onto latest main..."
          git fetch origin main
          git rebase origin/main
          
          if [ $? -ne 0 ]; then
            echo "âŒ Rebase failed - PR has conflicts with main"
            echo "Please update your PR branch and resolve conflicts first"
            git rebase --abort
            exit 1
          fi
          
          echo "âœ… PR branch rebased onto latest main"
          
          # Ensure working directory reflects rebased state
          echo "ğŸ”„ Updating working directory..."
          git reset --hard HEAD
          
          echo "ğŸ“Š Current commit: $(git rev-parse --short HEAD)"
          echo "ğŸ“Š Files changed from main: $(git diff --name-only origin/main | wc -l)"
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Setup SSH key for deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          # Try base64 decode first, fallback to raw key
          if echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
            echo "âœ… Decoded base64 SSH key"
          else
            echo "ğŸ“ Using raw SSH key"
            printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          fi
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 44.222.168.46 >> ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1 && echo "âœ… SSH key configured" || (echo "âŒ SSH key validation failed" && exit 1)
      
      - name: Create development config
        run: |
          echo "ğŸ“ Creating development configuration..."
          cat > apps/frontend/public/config.js << EOF
          window.CONFIG = {
            API_BASE_URL: 'http://44.222.168.46',
            apiEndpoint: 'http://44.222.168.46:8081',
            EC2_TERMINAL_URL: 'ws://44.222.168.46:8080',
            GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}',
            PROD_VERSION: '4.0.0-dev',
            ENVIRONMENT: 'development',
            environment: 'development',
            stage: 'dev',
            region: 'us-east-1',
            storiesTable: 'aipm-backend-dev-stories',
            acceptanceTestsTable: 'aipm-backend-dev-acceptance-tests',
            DEBUG: true
          };
          EOF
          
          echo "âœ… Development config created"
      
      - name: Deploy backend to development EC2
        run: |
          echo "ğŸš€ Deploying backend to development EC2..."
          ./scripts/deploy-to-environment.sh dev
          
          echo "âœ… Backend deployed to development EC2"
      
      - name: Sync database from production to development
        run: |
          echo "ğŸ”„ Syncing database from production to development..."
          
          # Scan production tables
          echo "ğŸ“¥ Exporting from production..."
          aws dynamodb scan --table-name aipm-backend-prod-stories --region us-east-1 > /tmp/prod-stories.json
          aws dynamodb scan --table-name aipm-backend-prod-acceptance-tests --region us-east-1 > /tmp/prod-tests.json
          
          # Clear development tables (with -r flag to handle empty input)
          echo "ğŸ—‘ï¸ Clearing development tables..."
          aws dynamodb scan --table-name aipm-backend-dev-stories --region us-east-1 --attributes-to-get id | \
            jq -r '.Items[].id.N' | \
            xargs -r -I {} aws dynamodb delete-item --table-name aipm-backend-dev-stories --key '{"id":{"N":"{}"}}' --region us-east-1
          
          aws dynamodb scan --table-name aipm-backend-dev-acceptance-tests --region us-east-1 --attributes-to-get id | \
            jq -r '.Items[].id.N' | \
            xargs -r -I {} aws dynamodb delete-item --table-name aipm-backend-dev-acceptance-tests --key '{"id":{"N":"{}"}}' --region us-east-1
          
          # Import to development (with error handling for empty tables)
          echo "ğŸ“¤ Importing to development..."
          STORY_COUNT=$(jq '.Items | length' /tmp/prod-stories.json)
          TEST_COUNT=$(jq '.Items | length' /tmp/prod-tests.json)
          
          if [ "$STORY_COUNT" -gt 0 ]; then
            echo "  Importing $STORY_COUNT stories..."
            jq -c '.Items[]' /tmp/prod-stories.json | while IFS= read -r item; do
              echo "{\"TableName\":\"aipm-backend-dev-stories\",\"Item\":$item}" > /tmp/put-item.json
              aws dynamodb put-item --cli-input-json file:///tmp/put-item.json --region us-east-1 || echo "âš ï¸ Failed to import story"
            done
            echo "  âœ… Stories imported"
          else
            echo "âš ï¸ No stories to import"
          fi
          
          if [ "$TEST_COUNT" -gt 0 ]; then
            echo "  Importing $TEST_COUNT tests..."
            jq -c '.Items[]' /tmp/prod-tests.json | while IFS= read -r item; do
              echo "{\"TableName\":\"aipm-backend-dev-acceptance-tests\",\"Item\":$item}" > /tmp/put-item.json
              aws dynamodb put-item --cli-input-json file:///tmp/put-item.json --region us-east-1 || echo "âš ï¸ Failed to import test"
            done
            echo "  âœ… Tests imported"
          else
            echo "âš ï¸ No tests to import"
          fi
          
          echo "âœ… Database synced: $STORY_COUNT stories, $TEST_COUNT tests"
      
      - name: Deploy frontend to S3
        run: |
          echo "ğŸš€ Deploying frontend to S3..."
          aws s3 sync apps/frontend/public/ s3://aipm-dev-frontend-hosting/ \
            --exclude '.git/*' \
            --exclude 'node_modules/*' \
            --delete
          
          echo "âœ… Frontend deployed to S3"
          echo "ğŸŒ Development URL: http://aipm-dev-frontend-hosting.s3-website-us-east-1.amazonaws.com"
      
      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          
          # Check backend health
          if curl -sf http://44.222.168.46/health | jq -e '.status == "running"' > /dev/null; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
            exit 1
          fi
          
          echo "âœ… Deployment verified successfully"
