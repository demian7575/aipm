name: Create PR with Kiro CLI

on:
  workflow_dispatch:
    inputs:
      task_title:
        description: 'Task title'
        required: true
        type: string
      task_details:
        description: 'Task details and requirements'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install Kiro CLI
        run: |
          curl -fsSL https://cli.kiro.dev/install | bash
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          kiro-cli --version || echo "Kiro CLI installed"
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Generate code with Kiro CLI
        run: |
          BRANCH_NAME="feature/$(echo '${{ inputs.task_title }}' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-50)"
          
          git config user.name "aipm-bot"
          git config user.email "aipm-bot@github.com"
          git checkout -b "$BRANCH_NAME"
          
          # Create task file
          cat > TASK.md << 'EOF'
          # ${{ inputs.task_title }}
          
          ## Requirements
          ${{ inputs.task_details }}
          
          ## Implementation
          Generated by Kiro CLI
          EOF
          
          # Generate code with Kiro CLI
          echo "Generating code with Kiro CLI..."
          echo "Task: ${{ inputs.task_title }}. Requirements: ${{ inputs.task_details }}. Project context: AIPM is a vanilla JavaScript project with Express backend. Generate complete working JavaScript code with proper error handling and JSDoc comments. No TODO comments or placeholders." | kiro-cli chat || echo "Kiro generation attempted"
          
          # Commit all changes
          git add -A
          if git diff --staged --quiet; then
            echo "No changes generated, creating task file only"
            git add TASK.md
          fi
          
          git commit -m "feat: ${{ inputs.task_title }}" || echo "Nothing to commit"
          git push -u origin "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY=$(cat << 'PRBODY'
          ## AI-Generated Implementation
          
          Task: ${{ inputs.task_title }}
          
          ## Requirements
          ${{ inputs.task_details }}
          
          ## Implementation
          Code generated by Kiro CLI based on task requirements.
          
          ## Review Checklist
          - [ ] Code follows project conventions
          - [ ] No security issues
          - [ ] Functionality works as expected
          
          ## Testing
          Development: http://aipm-dev-frontend-hosting.s3-website-us-east-1.amazonaws.com
          Production: http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com
          PRBODY
          )
          
          gh pr create \
            --title "${{ inputs.task_title }}" \
            --body "$PR_BODY" \
            --base main \
            --head "${{ env.BRANCH_NAME }}"
