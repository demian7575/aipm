name: Create PR with Kiro CLI

on:
  workflow_dispatch:
    inputs:
      task_title:
        description: 'Task title'
        required: true
        type: string
      task_details:
        description: 'Task details and requirements'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Generate code with Kiro CLI on EC2
        run: |
          BRANCH_NAME="feature/$(echo '${{ inputs.task_title }}' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-50)"
          
          git config user.name "aipm-bot"
          git config user.email "aipm-bot@github.com"
          git checkout -b "$BRANCH_NAME"
          
          # Create task file
          cat > TASK.md << 'EOF'
          # ${{ inputs.task_title }}
          
          ## Requirements
          ${{ inputs.task_details }}
          
          ## Implementation
          Generated by Kiro CLI on EC2
          EOF
          
          # Call EC2 endpoint to generate code with Kiro CLI
          echo "Calling EC2 Kiro CLI service..."
          PROMPT="Task: ${{ inputs.task_title }}. Requirements: ${{ inputs.task_details }}. Project context: AIPM is a vanilla JavaScript project with Express backend. Generate complete working JavaScript code with proper error handling and JSDoc comments. No TODO comments or placeholders."
          
          # Call the EC2 Kiro API endpoint
          GENERATED_CODE=$(curl -s -X POST http://44.220.45.57:8081/generate-code \
            -H "Content-Type: application/json" \
            -d "{\"prompt\":\"$PROMPT\"}" | jq -r '.code // empty')
          
          if [ -n "$GENERATED_CODE" ]; then
            FILENAME=$(echo '${{ inputs.task_title }}' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]').js
            echo "$GENERATED_CODE" > "$FILENAME"
            echo "Generated code saved to $FILENAME"
          else
            echo "No code generated, using fallback"
            FILENAME="implementation.js"
            cat > "$FILENAME" << 'JSEOF'
// ${{ inputs.task_title }}
// ${{ inputs.task_details }}

/**
 * Implementation for: ${{ inputs.task_title }}
 * Generated by Kiro CLI on EC2
 */
function implementation() {
  // Implementation will be generated by Kiro CLI
  console.log('${{ inputs.task_title }}');
  return true;
}

export default implementation;
JSEOF
          fi
          
          # Commit all changes
          git add -A
          git commit -m "feat: ${{ inputs.task_title }}" || echo "Nothing to commit"
          git push -u origin "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY=$(cat << 'PRBODY'
          ## AI-Generated Implementation
          
          Task: ${{ inputs.task_title }}
          
          ## Requirements
          ${{ inputs.task_details }}
          
          ## Implementation
          Code generated by Kiro CLI running on EC2 instance.
          
          ## Review Checklist
          - [ ] Code follows project conventions
          - [ ] No security issues
          - [ ] Functionality works as expected
          
          ## Testing
          Development: http://aipm-dev-frontend-hosting.s3-website-us-east-1.amazonaws.com
          Production: http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com
          PRBODY
          )
          
          gh pr create \
            --title "${{ inputs.task_title }}" \
            --body "$PR_BODY" \
            --base main \
            --head "${{ env.BRANCH_NAME }}"
