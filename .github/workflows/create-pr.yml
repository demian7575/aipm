name: Create PR with Amazon Q

on:
  workflow_dispatch:
    inputs:
      task_title:
        description: 'Task title'
        required: true
        type: string
      task_details:
        description: 'Task details and requirements'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install Amazon Q CLI
        run: |
          curl -fsSL https://d3vv6lp55qjaqc.cloudfront.net/items/1P1b0z0W0c1j3e0Y3g3Y/amazon-q-cli-linux-x64.tar.gz -o q.tar.gz
          tar -xzf q.tar.gz
          sudo mv q /usr/local/bin/q
          chmod +x /usr/local/bin/q
          q --version || echo "Amazon Q CLI installed"
      
      - name: Generate code with Amazon Q
        run: |
          BRANCH_NAME="feature/$(echo '${{ inputs.task_title }}' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-50)"
          
          git config user.name "aipm-bot"
          git config user.email "aipm-bot@github.com"
          git checkout -b "$BRANCH_NAME"
          
          # Create task file
          cat > TASK.md << 'EOF'
          # ${{ inputs.task_title }}
          
          ## Requirements
          ${{ inputs.task_details }}
          
          ## Implementation
          Generated by Amazon Q CLI
          EOF
          
          # Generate code with Amazon Q
          echo "Generating code with Amazon Q..."
          q chat "Implement this feature: ${{ inputs.task_title }}. Requirements: ${{ inputs.task_details }}. Project context: AIPM is a vanilla JavaScript project with Express backend. Generate minimal working code." --non-interactive || echo "Amazon Q generation attempted"
          
          # Commit all changes
          git add -A
          if git diff --staged --quiet; then
            echo "No changes generated, creating task file only"
            git add TASK.md
          fi
          
          git commit -m "feat: ${{ inputs.task_title }}" || echo "Nothing to commit"
          git push -u origin "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY=$(cat << 'PRBODY'
          ## AI-Generated Implementation
          
          Task: ${{ inputs.task_title }}
          
          ## Requirements
          ${{ inputs.task_details }}
          
          ## Implementation
          Code generated by Amazon Q CLI based on task requirements.
          
          ## Review Checklist
          - [ ] Code follows project conventions
          - [ ] No security issues
          - [ ] Functionality works as expected
          
          ## Testing
          Development: http://aipm-dev-frontend-hosting.s3-website-us-east-1.amazonaws.com
          Production: http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com
          PRBODY
          )
          
          gh pr create \
            --title "${{ inputs.task_title }}" \
            --body "$PR_BODY" \
            --base main \
            --head "${{ env.BRANCH_NAME }}"
