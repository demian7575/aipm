name: Amazon Q Code Generation

on:
  workflow_dispatch:
    inputs:
      taskDescription:
        description: 'Task description for Amazon Q'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: develop
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Generate Code with Amazon Q
        env:
          TASK: ${{ github.event.inputs.taskDescription }}
        run: |
          # Create generation script
          cat > generate.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          
          echo "Task: $TASK"
          echo "Repository structure:"
          find apps -type f -name "*.js" | head -20
          
          # Call Amazon Q API via AWS CLI
          PROMPT="You are Amazon Q Developer working on the AIPM project.

          Repository structure:
          - apps/frontend/public/app.js (main UI, vanilla JavaScript)
          - apps/backend/app.js (Express API server)
          - No React/Vue frameworks, pure vanilla JS
          
          Task: $TASK
          
          Generate code changes. Output format:
          FILE: relative/path/to/file.ext
          \`\`\`language
          complete file content or changes
          \`\`\`"
          
          # Use Bedrock with Q-style context
          aws bedrock-runtime invoke-model \
            --model-id anthropic.claude-3-sonnet-20240229-v1:0 \
            --body "{\"anthropic_version\":\"bedrock-2023-05-31\",\"max_tokens\":4096,\"messages\":[{\"role\":\"user\",\"content\":\"$PROMPT\"}]}" \
            --region us-east-1 \
            response.json
          
          # Parse response
          cat response.json | jq -r '.content[0].text' > generated.txt
          cat generated.txt
          
          # Extract and create files
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const content = fs.readFileSync('generated.txt', 'utf8');
          const fileRegex = /FILE:\s*(.+?)\n```[\w]*\n([\s\S]+?)```/g;
          let match;
          let count = 0;
          
          while ((match = fileRegex.exec(content)) !== null) {
            const [, filePath, code] = match;
            const cleanPath = filePath.trim();
            const dir = path.dirname(cleanPath);
            
            if (dir !== '.' && !fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
            }
            
            fs.writeFileSync(cleanPath, code.trim() + '\n');
            console.log(`âœ… Created: ${cleanPath}`);
            count++;
          }
          
          if (count === 0) {
            console.log('âš ï¸ No files generated');
            fs.writeFileSync('TASK.md', `# Task\n\n${process.env.TASK}\n\nNo code generated.\n`);
          } else {
            console.log(`\nâœ… Generated ${count} file(s)`);
          }
          EOF
          SCRIPT
          
          chmod +x generate.sh
          bash generate.sh
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: ${{ github.event.inputs.taskDescription }}"
          branch: "amazonq/${{ github.run_number }}"
          base: develop
          title: "ğŸ¤– Amazon Q: ${{ github.event.inputs.taskDescription }}"
          body: |
            ## Amazon Q Generated Code
            
            **Task:** ${{ github.event.inputs.taskDescription }}
            
            ### âš ï¸ Human Review Required
            - [ ] Code quality check
            - [ ] Test the changes
            - [ ] Security review
            
            ### Generated by
            Amazon Q via Bedrock with repository context
            
            ### Next Steps
            1. Review code changes
            2. Test locally
            3. Merge when ready
