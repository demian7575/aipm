name: Amazon Q Code Generation

on:
  workflow_dispatch:
    inputs:
      taskDescription:
        description: 'Task description for Amazon Q'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: develop
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Amazon Q CLI
        run: |
          npm install -g @aws/amazon-q-developer-cli
          q --version
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Generate Code with Amazon Q
        env:
          TASK: ${{ github.event.inputs.taskDescription }}
        run: |
          echo "Task: $TASK"
          
          # Use Q CLI to generate code
          q chat "$TASK" --non-interactive --output changes.json || true
          
          # If Q generated changes, apply them
          if [ -f changes.json ]; then
            echo "‚úÖ Amazon Q generated changes"
            cat changes.json
          else
            echo "‚ö†Ô∏è No changes generated, creating placeholder"
            echo "# Task: $TASK" > TASK_DESCRIPTION.md
            echo "" >> TASK_DESCRIPTION.md
            echo "Amazon Q did not generate code changes." >> TASK_DESCRIPTION.md
            echo "Manual implementation required." >> TASK_DESCRIPTION.md
          fi
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: ${{ github.event.inputs.taskDescription }}"
          branch: "amazonq/${{ github.run_number }}"
          base: develop
          title: "ü§ñ Amazon Q: ${{ github.event.inputs.taskDescription }}"
          body: |
            ## Amazon Q Generated Code
            
            **Task:** ${{ github.event.inputs.taskDescription }}
            
            ### ‚ö†Ô∏è Human Review Required
            - [ ] Code quality check
            - [ ] Test the changes
            - [ ] Security review
            - [ ] Update if needed
            
            ### Generated by
            Amazon Q Developer CLI
            
            ### Next Steps
            1. Review the code changes
            2. Test locally if needed
            3. Update code if Amazon Q made mistakes
            4. Approve and merge when ready
