name: Amazon Q Code Generation

on:
  workflow_dispatch:
    inputs:
      taskDescription:
        description: 'Task description for Amazon Q'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: develop
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Generate Code with Amazon Q
        env:
          TASK: ${{ github.event.inputs.taskDescription }}
        run: |
          # Create Node.js generation script
          cat > generate.mjs << 'SCRIPT'
          import { BedrockRuntimeClient, InvokeModelCommand } from "@aws-sdk/client-bedrock-runtime";
          import fs from 'fs';
          import path from 'path';
          
          async function generateCode() {
            const client = new BedrockRuntimeClient({ region: "us-east-1" });
            
            const prompt = `You are Amazon Q Developer working on the AIPM project.

Repository structure:
- apps/frontend/public/app.js (main UI, vanilla JavaScript, 229KB)
- apps/backend/app.js (Express API server, 213KB)
- No React/Vue frameworks, uses vanilla JS and DOM manipulation
- DynamoDB for data storage
- AWS Lambda + API Gateway deployment

Task: ${process.env.TASK}

Generate REAL code changes with ACTUAL file paths.
Output format:
FILE: actual/path/to/file.ext
\`\`\`language
complete code content
\`\`\`

Example:
FILE: hello.txt
\`\`\`
Hello World
\`\`\``;
            
            const command = new InvokeModelCommand({
              modelId: "anthropic.claude-3-sonnet-20240229-v1:0",
              contentType: "application/json",
              accept: "application/json",
              body: JSON.stringify({
                anthropic_version: "bedrock-2023-05-31",
                max_tokens: 4096,
                messages: [{ role: "user", content: prompt }]
              })
            });
            
            const response = await client.send(command);
            const result = JSON.parse(new TextDecoder().decode(response.body));
            
            if (!result.content || !result.content[0]) {
              throw new Error("No content in response");
            }
            
            const content = result.content[0].text;
            console.log("Generated content:");
            console.log(content);
            
            // Parse and create files
            const fileRegex = /FILE:\s*(.+?)\n```[\w]*\n([\s\S]+?)```/g;
            let match;
            let count = 0;
            
            while ((match = fileRegex.exec(content)) !== null) {
              const [, filePath, code] = match;
              const cleanPath = filePath.trim();
              const dir = path.dirname(cleanPath);
              
              if (dir !== '.' && !fs.existsSync(dir)) {
                fs.mkdirSync(dir, { recursive: true });
              }
              
              fs.writeFileSync(cleanPath, code.trim() + '\n');
              console.log(`‚úÖ Created: ${cleanPath}`);
              count++;
            }
            
            if (count === 0) {
              console.log('‚ö†Ô∏è No files generated, creating task description');
              fs.writeFileSync('TASK.md', `# Task\n\n${process.env.TASK}\n\nAmazon Q response:\n${content}\n`);
            } else {
              console.log(`\n‚úÖ Generated ${count} file(s)`);
            }
          }
          
          generateCode().catch(err => {
            console.error("‚ùå Error:", err.message);
            process.exit(1);
          });
          SCRIPT
          
          npm install @aws-sdk/client-bedrock-runtime
          node generate.mjs
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: ${{ github.event.inputs.taskDescription }}"
          branch: "amazonq/${{ github.run_number }}"
          base: develop
          title: "ü§ñ Amazon Q: ${{ github.event.inputs.taskDescription }}"
          body: |
            ## Amazon Q Generated Code
            
            **Task:** ${{ github.event.inputs.taskDescription }}
            
            ### ‚ö†Ô∏è Human Review Required
            - [ ] Code quality check
            - [ ] Test the changes
            
            ### Generated by
            Amazon Q via Bedrock with repository context
