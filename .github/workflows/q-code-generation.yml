name: Amazon Q Code Generation

on:
  workflow_dispatch:
    inputs:
      taskDescription:
        description: 'Task description for Amazon Q'
        required: true
      targetBranch:
        description: 'Target branch for changes'
        required: false
        default: 'develop'

jobs:
  generate-code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.targetBranch }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Generate Code with Amazon Bedrock
        env:
          TASK_DESCRIPTION: ${{ github.event.inputs.taskDescription }}
        run: |
          cat > generate-code.js << 'EOF'
          const { BedrockRuntimeClient, InvokeModelCommand } = require("@aws-sdk/client-bedrock-runtime");
          
          async function generateCode() {
            const client = new BedrockRuntimeClient({ region: "us-east-1" });
            const prompt = `You are a code generator. Generate code for this task: ${process.env.TASK_DESCRIPTION}
            
            Provide only the code changes needed, with file paths and content.
            Format: 
            FILE: path/to/file.js
            \`\`\`javascript
            code here
            \`\`\`
            `;
            
            const command = new InvokeModelCommand({
              modelId: "anthropic.claude-3-sonnet-20240229-v1:0",
              body: JSON.stringify({
                anthropic_version: "bedrock-2023-05-31",
                max_tokens: 4096,
                messages: [{ role: "user", content: prompt }]
              })
            });
            
            const response = await client.send(command);
            const result = JSON.parse(new TextDecoder().decode(response.body));
            console.log(result.content[0].text);
          }
          
          generateCode().catch(console.error);
          EOF
          
          npm install @aws-sdk/client-bedrock-runtime
          node generate-code.js > generated-code.txt
      
      - name: Apply Generated Changes
        run: |
          echo "Generated code saved to generated-code.txt"
          echo "Manual review required before applying changes"
          cat generated-code.txt
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: ${{ github.event.inputs.taskDescription }}"
          branch: "q-generated-${{ github.run_number }}"
          title: "ðŸ¤– Amazon Q: ${{ github.event.inputs.taskDescription }}"
          body: |
            ## Amazon Q Generated Code
            
            **Task:** ${{ github.event.inputs.taskDescription }}
            
            This PR contains code generated by Amazon Q via Bedrock.
            
            ### Generated Changes
            See commits for details.
            
            ### Review Required
            - [ ] Code quality check
            - [ ] Security review
            - [ ] Test coverage
            
            **Generated at:** ${{ github.event.repository.updated_at }}
