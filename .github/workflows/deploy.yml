name: Deploy AIPM to AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Build application
      run: npm run build
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Install Serverless Framework
      run: npm install -g serverless
      
    - name: Deploy backend to AWS Lambda
      run: serverless deploy --verbose
      
    - name: Deploy frontend to S3
      run: |
        aws s3 sync dist/ s3://aipm-static-hosting-demo --delete
        
    - name: Test deployment
      run: |
        # Test frontend
        curl -f http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com/ || exit 1
        
        # Test backend health endpoint
        API_URL=$(serverless info --verbose | grep -o 'https://[^[:space:]]*' | head -1)
        curl -f "$API_URL/health" || exit 1
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ AIPM deployed successfully!"
          echo "Frontend: http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com/"
          echo "Backend: $(serverless info --verbose | grep -o 'https://[^[:space:]]*' | head -1)"
        else
          echo "❌ Deployment failed"
        fi
