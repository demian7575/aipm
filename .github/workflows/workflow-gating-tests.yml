name: AIPM Structured Gating Tests

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      phase:
        description: 'Test phase to run (1, 2, 3, or all)'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - '1'
        - '2'
        - '3'

permissions:
  contents: read
  pull-requests: write

jobs:
  # Phase 1: Critical Security & Data Safety (BLOCKS deployment)
  phase1-critical:
    runs-on: ubuntu-latest
    if: github.event.inputs.phase == 'all' || github.event.inputs.phase == '1' || github.event.inputs.phase == ''
    outputs:
      phase1-status: ${{ steps.phase1.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Load environment configuration
        run: |
          source scripts/utilities/load-env-config.sh production
          echo "API_BASE=$API_BASE" >> $GITHUB_ENV
          echo "SEMANTIC_API_BASE=$SEMANTIC_API_BASE" >> $GITHUB_ENV
          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
      
      - name: Run Phase 1 - Critical Security & Data Safety
        id: phase1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_ENV: prod
        run: |
          echo "ğŸ”´ Running Phase 1: Critical Security & Data Safety"
          
          if ./scripts/testing/phase1-security-data-safety.sh; then
            echo "âœ… Phase 1 PASSED - Deployment approved"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Phase 1 FAILED - BLOCKING DEPLOYMENT"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Phase 2: Complete E2E Workflow (BLOCKS deployment)
  phase2-e2e:
    runs-on: ubuntu-latest
    needs: phase1-critical
    if: (github.event.inputs.phase == 'all' || github.event.inputs.phase == '2' || github.event.inputs.phase == '') && needs.phase1-critical.outputs.phase1-status == 'success'
    outputs:
      phase2-status: ${{ steps.phase2.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Load environment configuration
        run: |
          source scripts/utilities/load-env-config.sh production
          echo "API_BASE=$API_BASE" >> $GITHUB_ENV
          echo "SEMANTIC_API_BASE=$SEMANTIC_API_BASE" >> $GITHUB_ENV
          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
      
      - name: Setup SSH for EC2 access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_IP }} >> ~/.ssh/known_hosts
      
      - name: Run Phase 2 - Complete E2E Workflow
        id: phase2
        env:
          TEST_DB_ENV: dev
          TEST_USE_MOCK_GITHUB: true
          TEST_SSH_HOST: ${{ env.EC2_IP }}
          USE_KIRO_MOCK: false
          TARGET_ENV: prod
        run: |
          echo "ğŸŸ¡ Running Phase 2: Complete E2E Workflow"
          echo "   Database: Dev (safe)"
          echo "   GitHub: Mock (no real PRs)"
          echo "   Kiro: Real (Semantic API)"
          
          if timeout 120 ./scripts/testing/phase2-optimized.sh; then
            echo "âœ… Phase 2 PASSED - E2E workflow validated"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Phase 2 FAILED - BLOCKING DEPLOYMENT"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Generate comprehensive test report
  generate-report:
    runs-on: ubuntu-latest
    needs: [phase1-critical, phase2-e2e]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Generate Test Report
        run: |
          echo "ğŸ“Š Generating Comprehensive Test Report"
          
          cat > gating-test-report.md << EOF
          # AIPM Structured Gating Tests Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Trigger:** ${{ github.event_name }}
          
          ## Test Results Summary
          
          | Phase | Priority | Status | Impact |
          |-------|----------|--------|---------|
          | Phase 1: Security & Data Safety | ğŸ”´ Critical | ${{ needs.phase1-critical.outputs.phase1-status || 'skipped' }} | ${{ needs.phase1-critical.outputs.phase1-status == 'success' && 'Deployment Approved' || 'BLOCKS Deployment' }} |
          | Phase 2: Complete E2E Workflow | ğŸ”´ Critical | ${{ needs.phase2-e2e.outputs.phase2-status || 'skipped' }} | ${{ needs.phase2-e2e.outputs.phase2-status == 'success' && 'E2E Validated' || 'BLOCKS Deployment' }} |
          
          ## Overall Assessment
          
          EOF
          
          # Determine overall status
          if [[ "${{ needs.phase1-critical.outputs.phase1-status }}" == "success" ]] && [[ "${{ needs.phase2-e2e.outputs.phase2-status }}" == "success" ]]; then
            echo "âœ… **DEPLOYMENT APPROVED**" >> gating-test-report.md
            echo "" >> gating-test-report.md
            echo "Critical security, data safety, and E2E workflow requirements met." >> gating-test-report.md
            
            if [[ "${{ needs.phase3-infrastructure.outputs.phase3-status }}" == "success" ]]; then
              echo "âœ… Infrastructure and monitoring fully validated." >> gating-test-report.md
            else
              echo "â„¹ï¸  Infrastructure issues detected - informational only." >> gating-test-report.md
            fi
          else
            echo "âŒ **DEPLOYMENT BLOCKED**" >> gating-test-report.md
            echo "" >> gating-test-report.md
            if [[ "${{ needs.phase1-critical.outputs.phase1-status }}" != "success" ]]; then
              echo "Critical security or data safety issues must be resolved." >> gating-test-report.md
            fi
            if [[ "${{ needs.phase2-e2e.outputs.phase2-status }}" != "success" ]]; then
              echo "E2E workflow validation failed - system not ready for deployment." >> gating-test-report.md
            fi
          fi
          
          echo "" >> gating-test-report.md
          echo "## Test Coverage" >> gating-test-report.md
          echo "" >> gating-test-report.md
          echo "### Phase 1: Security & Data Safety" >> gating-test-report.md
          echo "- ğŸ”’ Security validation (GitHub tokens, AWS IAM, secrets)" >> gating-test-report.md
          echo "- ğŸ—„ï¸ Database integrity (schema, consistency, billing)" >> gating-test-report.md
          echo "- ğŸ”„ Deployment safety (git state, artifacts, service health)" >> gating-test-report.md
          echo "- ğŸŒ Infrastructure health (API, Semantic API, Frontend)" >> gating-test-report.md
          echo "" >> gating-test-report.md
          echo "### Phase 2: Complete E2E Workflow" >> gating-test-report.md
          echo "- ğŸ“ Story Draft Generation (AI)" >> gating-test-report.md
          echo "- âœï¸  Acceptance Test Draft (AI)" >> gating-test-report.md
          echo "- ğŸ”€ GitHub Integration (Mock)" >> gating-test-report.md
          echo "- ğŸ’» Code Generation (Real Semantic API)" >> gating-test-report.md
          echo "- ğŸš€ Story Status Workflow" >> gating-test-report.md
          echo "- ğŸ” Data Consistency Verification" >> gating-test-report.md
          echo "- ğŸ—‘ï¸  Cascade Delete Validation" >> gating-test-report.md
      
      - name: Comment Test Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const testReport = fs.readFileSync('gating-test-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: testReport
            });
      
      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: structured-gating-test-report
          path: gating-test-report.md
          retention-days: 30
      
      - name: Set Final Status
        if: always()
        run: |
          if [[ "${{ needs.phase1-critical.outputs.phase1-status }}" == "success" ]] && [[ "${{ needs.phase2-e2e.outputs.phase2-status }}" == "success" ]]; then
            echo "ğŸ‰ Structured gating tests completed successfully!"
            echo "âœ… System approved for deployment"
            exit 0
          else
            echo "âŒ Critical gating tests failed"
            echo "ğŸš« Deployment blocked until issues resolved"
            exit 1
          fi
