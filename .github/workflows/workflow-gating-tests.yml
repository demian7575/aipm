name: AIPM Structured Gating Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      phase:
        description: 'Test phase to run (1, 2, 3, or all)'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - '1'
        - '2'
        - '3'

permissions:
  contents: read
  pull-requests: write

jobs:
  # Phase 1: Critical Security & Data Safety (BLOCKS deployment)
  phase1-critical:
    runs-on: ubuntu-latest
    if: github.event.inputs.phase == 'all' || github.event.inputs.phase == '1' || github.event.inputs.phase == ''
    outputs:
      phase1-status: ${{ steps.phase1.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Run Phase 1 - Critical Security & Data Safety
        id: phase1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”´ Running Phase 1: Critical Security & Data Safety"
          
          if ./scripts/testing/phase1-security-data-safety.sh; then
            echo "âœ… Phase 1 PASSED - Deployment approved"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Phase 1 FAILED - BLOCKING DEPLOYMENT"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Phase 2: Performance & API Safety (WARNS on failure)
  phase2-performance:
    runs-on: ubuntu-latest
    needs: phase1-critical
    if: (github.event.inputs.phase == 'all' || github.event.inputs.phase == '2' || github.event.inputs.phase == '') && needs.phase1-critical.outputs.phase1-status == 'success'
    outputs:
      phase2-status: ${{ steps.phase2.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Run Phase 2 - Performance & API Safety
        id: phase2
        run: |
          echo "ğŸŸ¡ Running Phase 2: Performance & API Safety"
          
          if ./scripts/testing/phase2-performance-api.sh; then
            echo "âœ… Phase 2 PASSED"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Phase 2 FAILED - Performance/API issues detected"
            echo "status=failure" >> $GITHUB_OUTPUT
            # Don't exit 1 - this is a warning, not blocking
          fi

  # Phase 3: Infrastructure & Monitoring (INFORMATIONAL)
  phase3-infrastructure:
    runs-on: ubuntu-latest
    needs: [phase1-critical, phase2-performance]
    if: (github.event.inputs.phase == 'all' || github.event.inputs.phase == '3' || github.event.inputs.phase == '') && needs.phase1-critical.outputs.phase1-status == 'success'
    outputs:
      phase3-status: ${{ steps.phase3.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl dnsutils iputils-ping
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Run Phase 3 - Infrastructure & Monitoring
        id: phase3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸŸ¢ Running Phase 3: Infrastructure & Monitoring"
          
          if ./scripts/testing/phase3-infrastructure-monitoring.sh; then
            echo "âœ… Phase 3 PASSED"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  Phase 3 FAILED - Infrastructure issues detected (informational)"
            echo "status=failure" >> $GITHUB_OUTPUT
            # Don't exit 1 - this is informational only
          fi

  # Generate comprehensive test report
  generate-report:
    runs-on: ubuntu-latest
    needs: [phase1-critical, phase2-performance, phase3-infrastructure]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Generate Test Report
        run: |
          echo "ğŸ“Š Generating Comprehensive Test Report"
          
          cat > gating-test-report.md << EOF
          # AIPM Structured Gating Tests Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Trigger:** ${{ github.event_name }}
          
          ## Test Results Summary
          
          | Phase | Priority | Status | Impact |
          |-------|----------|--------|---------|
          | Phase 1: Security & Data Safety | ğŸ”´ Critical | ${{ needs.phase1-critical.outputs.phase1-status || 'skipped' }} | ${{ needs.phase1-critical.outputs.phase1-status == 'success' && 'Deployment Approved' || 'BLOCKS Deployment' }} |
          | Phase 2: Performance & API | ğŸŸ¡ High | ${{ needs.phase2-performance.outputs.phase2-status || 'skipped' }} | ${{ needs.phase2-performance.outputs.phase2-status == 'success' && 'Performance Validated' || 'Performance Warning' }} |
          | Phase 3: Infrastructure & Monitoring | ğŸŸ¢ Medium | ${{ needs.phase3-infrastructure.outputs.phase3-status || 'skipped' }} | ${{ needs.phase3-infrastructure.outputs.phase3-status == 'success' && 'Infrastructure Healthy' || 'Infrastructure Issues (Info)' }} |
          
          ## Overall Assessment
          
          EOF
          
          # Determine overall status
          if [[ "${{ needs.phase1-critical.outputs.phase1-status }}" == "success" ]]; then
            echo "âœ… **DEPLOYMENT APPROVED**" >> gating-test-report.md
            echo "" >> gating-test-report.md
            echo "Critical security and data safety requirements met." >> gating-test-report.md
            
            if [[ "${{ needs.phase2-performance.outputs.phase2-status }}" == "success" ]]; then
              echo "âœ… Performance and API requirements also met." >> gating-test-report.md
            else
              echo "âš ï¸  Performance/API issues detected - consider addressing." >> gating-test-report.md
            fi
            
            if [[ "${{ needs.phase3-infrastructure.outputs.phase3-status }}" == "success" ]]; then
              echo "âœ… Infrastructure and monitoring fully validated." >> gating-test-report.md
            else
              echo "â„¹ï¸  Infrastructure issues detected - informational only." >> gating-test-report.md
            fi
          else
            echo "âŒ **DEPLOYMENT BLOCKED**" >> gating-test-report.md
            echo "" >> gating-test-report.md
            echo "Critical security or data safety issues must be resolved before deployment." >> gating-test-report.md
          fi
          
          echo "" >> gating-test-report.md
          echo "## Test Coverage" >> gating-test-report.md
          echo "- ğŸ”’ Security validation (GitHub tokens, AWS IAM, secrets)" >> gating-test-report.md
          echo "- ğŸ—„ï¸ Database integrity (schema, consistency, billing)" >> gating-test-report.md
          echo "- ğŸ”„ Deployment safety (git state, artifacts, service health)" >> gating-test-report.md
          echo "- âš¡ Performance validation (response times, concurrency)" >> gating-test-report.md
          echo "- ğŸ“‹ API contract validation (schema, versioning, CORS)" >> gating-test-report.md
          echo "- ğŸ“Š Resource limits (throttling, rate limiting, payload size)" >> gating-test-report.md
          echo "- ğŸŒ Network infrastructure (DNS, connectivity, SSL)" >> gating-test-report.md
          echo "- ğŸ“Š Monitoring integration (health endpoints, logs, CloudWatch)" >> gating-test-report.md
          echo "- ğŸ”— System integration (GitHub API, frontend-backend, templates)" >> gating-test-report.md
      
      - name: Comment Test Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const testReport = fs.readFileSync('gating-test-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: testReport
            });
      
      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: structured-gating-test-report
          path: gating-test-report.md
          retention-days: 30
      
      - name: Set Final Status
        if: always()
        run: |
          if [[ "${{ needs.phase1-critical.outputs.phase1-status }}" == "success" ]]; then
            echo "ğŸ‰ Structured gating tests completed successfully!"
            echo "âœ… System approved for deployment"
            exit 0
          else
            echo "âŒ Critical gating tests failed"
            echo "ğŸš« Deployment blocked until issues resolved"
            exit 1
          fi
