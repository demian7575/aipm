name: Run in Staging

on:
  workflow_dispatch:
    inputs:
      task_title:
        description: 'Task title'
        required: true
      task_details:
        description: 'Detailed requirements and acceptance criteria'
        required: false

jobs:
  implement-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: develop
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install kiro-cli
        run: |
          npm install -g @aws/kiro-cli || echo "kiro-cli installation skipped"
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Create feature branch
        run: |
          BRANCH_NAME="staging/$(echo '${{ github.event.inputs.task_title }}' | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | cut -c1-50)-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "FEATURE_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Implement with Amazon Q
        run: |
          echo "Task: ${{ github.event.inputs.task_title }}"
          echo "Details: ${{ github.event.inputs.task_details }}"
          echo "Implementing changes..."
          # Placeholder for kiro-cli implementation
          # In production, this would call: kiro-cli chat "${{ github.event.inputs.task_details }}"
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "feat: ${{ github.event.inputs.task_title }}"
      
      - name: Push feature branch
        run: |
          git push origin "$FEATURE_BRANCH"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.FEATURE_BRANCH }}
          base: main
          title: ${{ github.event.inputs.task_title }}
          body: |
            ## Task Details
            ${{ github.event.inputs.task_details }}
            
            ## Implementation
            Implemented by Amazon Q (kiro-cli) via Run in Staging workflow.
            
            ## Testing
            Deployed to development environment for testing.
      
      - name: Install dependencies
        run: npm install
      
      - name: Deploy to Development
        run: bash deploy-dev-full.sh
      
      - name: Output results
        run: |
          echo "‚úÖ Implementation complete: ${{ github.event.inputs.task_title }}"
          echo "üåø Feature branch: $FEATURE_BRANCH"
          echo "üìã PR created to main branch"
          echo "üåê Development URL: http://aipm-dev-frontend-hosting.s3-website-us-east-1.amazonaws.com/"
