name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write

jobs:
  # First run gating tests to validate the system
  gating-tests:
    runs-on: ubuntu-latest
    outputs:
      gating-status: ${{ steps.gating.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps
          sudo apt-get update
          sudo apt-get install -y jq python3-yaml
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Run Pre-Production Gating Tests
        id: gating
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§ª Running Pre-Production Gating Tests"
          export PHASE="pre-production"
          
          if ./scripts/testing/run-structured-gating-tests.sh; then
            echo "âœ… Gating tests passed - production deployment approved"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Gating tests failed"
            if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
              echo "âš ï¸ Force deploy enabled - proceeding despite test failures"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "ðŸš« Blocking production deployment"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

  # Only deploy if gating tests pass or force deploy is enabled
  deploy-production:
    runs-on: ubuntu-latest
    needs: gating-tests
    if: needs.gating-tests.outputs.gating-status == 'success'
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Deploy to production environment
        run: |
          echo "ðŸš€ Deploying to production environment..."
          
          # Create production config
          echo "ðŸ“ Creating production configuration..."
          cat > apps/frontend/public/config.js << EOF
          window.CONFIG = {
            API_BASE_URL: 'http://44.220.45.57',
            apiEndpoint: 'http://44.220.45.57:8081',
            EC2_TERMINAL_URL: 'ws://44.220.45.57:8080',
            GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}',
            PROD_VERSION: '4.0.0',
            ENVIRONMENT: 'production',
            environment: 'production',
            stage: 'prod',
            region: 'us-east-1',
            storiesTable: 'aipm-backend-prod-stories',
            acceptanceTestsTable: 'aipm-backend-prod-acceptance-tests',
            DEBUG: false
          };
          EOF
          
          echo "âœ… Production config created"
      
      - name: Deploy backend to EC2
        run: |
          echo "ðŸ“¦ Deploying backend to production EC2..."
          
          # Upload backend file to S3 for transfer
          aws s3 cp apps/backend/app.js s3://aipm-deployments-728378229251/prod/app.js
          
          # Deploy to production EC2 via SSH
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > /tmp/ec2_key
          chmod 600 /tmp/ec2_key
          
          scp -i /tmp/ec2_key -o StrictHostKeyChecking=no apps/backend/app.js ec2-user@44.220.45.57:~/aipm/apps/backend/app.js
          
          # Restart production backend with correct environment variables
          ssh -i /tmp/ec2_key -o StrictHostKeyChecking=no ec2-user@44.220.45.57 '
            cd ~/aipm && 
            pkill -f "node.*app.js" 2>/dev/null || true &&
            STORIES_TABLE=aipm-backend-prod-stories \
            ACCEPTANCE_TESTS_TABLE=aipm-backend-prod-acceptance-tests \
            PROD_VERSION=4.0.0 \
            STAGE=prod \
            nohup node apps/backend/app.js > server.log 2>&1 &
          '
          
          # Clean up key
          rm /tmp/ec2_key
          
          echo "âœ… Backend deployed to production EC2"
      
      - name: Deploy frontend to S3
        run: |
          echo "ðŸ“¦ Deploying frontend to production S3..."
          aws s3 sync apps/frontend/public/ s3://aipm-static-hosting-demo --delete --cache-control no-cache
          echo "âœ… Frontend deployed to production S3"
      
      - name: Run Post-Deployment Validation
        id: post_deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Running Post-Deployment Validation"
          
          # Wait for deployment to be ready
          sleep 15
          
          # Test production environment health
          echo "Testing production environment..."
          
          # Frontend accessibility
          if curl -s "http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com" | grep -q "AI Project Manager"; then
            echo "âœ… Production frontend accessible"
          else
            echo "âŒ Production frontend not accessible"
            exit 1
          fi
          
          # Backend API health
          if curl -s "http://44.220.45.57/api/version" | grep -q "version"; then
            echo "âœ… Production backend healthy"
          else
            echo "âŒ Production backend not healthy"
            exit 1
          fi
          
          # Run post-deployment gating tests
          export PHASE="post-production"
          if ./scripts/testing/run-structured-gating-tests.sh; then
            echo "âœ… Post-deployment validation passed"
          else
            echo "âŒ Post-deployment validation failed"
            exit 1
          fi
      
      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ steps.post_deployment.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Frontend: http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Backend API: http://44.220.45.57" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Kiro API: http://44.220.45.57:8081" >> $GITHUB_STEP_SUMMARY
