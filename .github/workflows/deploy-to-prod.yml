name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write

jobs:
  # First run gating tests to validate the system
  gating-tests:
    runs-on: ubuntu-latest
    outputs:
      gating-status: ${{ steps.gating.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps
          sudo apt-get update
          sudo apt-get install -y jq python3-yaml
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Load environment configuration
        run: |
          source scripts/utilities/load-env-config.sh production
          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
          echo "API_BASE=$API_BASE" >> $GITHUB_ENV
          echo "SEMANTIC_API_BASE=$SEMANTIC_API_BASE" >> $GITHUB_ENV
          echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          echo "S3_URL=$S3_URL" >> $GITHUB_ENV
      
      - name: Setup SSH key for testing
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          if echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
            echo "âœ… Decoded base64 SSH key"
          else
            echo "ðŸ“ Using raw SSH key"
            printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          fi
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_IP >> ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1 && echo "âœ… SSH key configured" || (echo "âŒ SSH key validation failed" && exit 1)
      
      - name: Run Pre-Production Gating Tests
        id: gating
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_ENV: prod
          SSH_HOST: ${{ env.EC2_IP }}
        run: |
          echo "ðŸ§ª Running Pre-Production Gating Tests (Phase 1 + Phase 2)"
          export PHASE="pre-production"
          
          # Run Phase 1 (Security & Data Safety) and Phase 2 (E2E Workflow)
          if ./scripts/testing/run-structured-gating-tests.sh --phases "1,2"; then
            echo "âœ… Gating tests passed - production deployment approved"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Gating tests failed"
            if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
              echo "âš ï¸ Force deploy enabled - proceeding despite test failures"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "ðŸš« Blocking production deployment"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

  # Only deploy if gating tests pass or force deploy is enabled
  deploy-production:
    runs-on: ubuntu-latest
    needs: gating-tests
    if: needs.gating-tests.outputs.gating-status == 'success'
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Load environment configuration
        run: |
          source scripts/utilities/load-env-config.sh production
          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
          echo "API_BASE=$API_BASE" >> $GITHUB_ENV
          echo "SEMANTIC_API_BASE=$SEMANTIC_API_BASE" >> $GITHUB_ENV
          echo "TERMINAL_URL=$TERMINAL_URL" >> $GITHUB_ENV
          echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          echo "S3_URL=$S3_URL" >> $GITHUB_ENV
          echo "DYNAMODB_STORIES_TABLE=$DYNAMODB_STORIES_TABLE" >> $GITHUB_ENV
          echo "DYNAMODB_TESTS_TABLE=$DYNAMODB_TESTS_TABLE" >> $GITHUB_ENV
          
          # Load dev config for SSH known_hosts
          source scripts/utilities/load-env-config.sh development
          echo "DEV_EC2_IP=$EC2_IP" >> $GITHUB_ENV
      
      - name: Setup SSH key for deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          # Try base64 decode first, fallback to raw key
          if echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
            echo "âœ… Decoded base64 SSH key"
          else
            echo "ðŸ“ Using raw SSH key"
            printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          fi
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_IP >> ~/.ssh/known_hosts
          ssh-keyscan -H $DEV_EC2_IP >> ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1 && echo "âœ… SSH key configured and validated" || (echo "âŒ SSH key validation failed" && exit 1)
      
      - name: Deploy to production environment
        run: |
          echo "ðŸš€ Deploying to production environment..."
          
          # Create production config
          echo "ðŸ“ Creating production configuration..."
          cat > apps/frontend/public/config.js << EOF
          window.CONFIG = {
            API_BASE_URL: '${{ env.API_BASE }}',
            EC2_TERMINAL_URL: '${{ env.TERMINAL_URL }}',
            GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}',
            PROD_VERSION: '4.0.0',
            ENVIRONMENT: 'production',
            environment: 'production',
            stage: 'prod',
            region: 'us-east-1',
            storiesTable: '${{ env.DYNAMODB_STORIES_TABLE }}',
            acceptanceTestsTable: '${{ env.DYNAMODB_TESTS_TABLE }}',
            DEBUG: false
          };
          EOF
          
          echo "âœ… Production config created"
      
      - name: Deploy to production environment
        run: |
          echo "ðŸš€ Deploying to production environment using unified script..."
          ./scripts/deploy-to-environment.sh prod
          
          echo "âœ… Backend deployed to production EC2"
          echo "â„¹ï¸  Templates updated - Kiro will read from disk on next request"
      
      - name: Deploy frontend to S3
        run: |
          echo "ðŸ“¦ Deploying frontend to production S3..."
          aws s3 sync apps/frontend/public/ s3://${{ env.S3_BUCKET }} --delete --cache-control no-cache
          echo "âœ… Frontend deployed to production S3"
      
      - name: Run Post-Deployment Validation
        id: post_deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_ENV: prod
          SSH_HOST: ${{ env.EC2_IP }}
        run: |
          echo "ðŸ” Running Post-Deployment Validation"
          
          # Wait for deployment to be ready
          sleep 15
          
          # Test production environment health
          echo "Testing production environment..."
          
          # Frontend accessibility
          if curl -s "${{ env.S3_URL }}" | grep -q "AI Project Manager"; then
            echo "âœ… Production frontend accessible"
          else
            echo "âŒ Production frontend not accessible"
            exit 1
          fi
          
          # Backend API health
          if curl -s "${{ env.API_BASE }}/api/version" | grep -q "version"; then
            echo "âœ… Production backend healthy"
          else
            echo "âŒ Production backend not healthy"
            exit 1
          fi
          
          # Run post-deployment gating tests (Phase 1 + Phase 2)
          # Phase 2 uses Production backend with Development tables (via X-Use-Dev-Tables header)
          export PHASE="post-production"
          export API_BASE="http://44.197.204.18:4000"
          export SEMANTIC_API_BASE="http://44.197.204.18:8083"
          
          if ./scripts/testing/run-structured-gating-tests.sh --phases "1,2"; then
            echo "âœ… Post-deployment validation passed"
          else
            echo "âŒ Post-deployment validation failed"
            exit 1
          fi
      
      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ steps.post_deployment.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Frontend: http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Backend API: http://44.197.204.18:4000" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Semantic API: http://44.197.204.18:8083" >> $GITHUB_STEP_SUMMARY
