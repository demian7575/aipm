name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write

jobs:
  # Step 1: Deploy to Development and run Pre-Production tests
  deploy-and-test-dev:
    runs-on: ubuntu-latest
    outputs:
      gating-status: ${{ steps.gating.outputs.status }}
    environment: development
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps
          sudo apt-get update
          sudo apt-get install -y jq python3-yaml
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Load Development environment configuration
        run: |
          source scripts/utilities/load-env-config.sh dev
          echo "DEV_EC2_IP=$EC2_IP" >> $GITHUB_ENV
          echo "DEV_API_BASE=$API_BASE" >> $GITHUB_ENV
          echo "DEV_SEMANTIC_API_BASE=$SEMANTIC_API_BASE" >> $GITHUB_ENV
          echo "DEV_S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          echo "DEV_TERMINAL_URL=$TERMINAL_URL" >> $GITHUB_ENV
          echo "DEV_DYNAMODB_STORIES_TABLE=$DYNAMODB_STORIES_TABLE" >> $GITHUB_ENV
          echo "DEV_DYNAMODB_TESTS_TABLE=$DYNAMODB_TESTS_TABLE" >> $GITHUB_ENV
      
      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          if echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
            echo "âœ… Decoded base64 SSH key"
          else
            echo "ðŸ“ Using raw SSH key"
            printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          fi
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $DEV_EC2_IP >> ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1 && echo "âœ… SSH key configured" || (echo "âŒ SSH key validation failed" && exit 1)
      
      - name: Deploy to Development EC2
        run: |
          echo "ðŸš€ Deploying to Development EC2 for Pre-Production testing..."
          ./scripts/deploy-to-environment.sh dev
          echo "âœ… Backend deployed to Development EC2"
      
      - name: Deploy frontend to Development S3
        run: |
          echo "ðŸ“¦ Deploying frontend to Development S3..."
          
          # Create dev config
          cat > apps/frontend/public/config.js << EOF
          window.CONFIG = {
            API_BASE_URL: '${{ env.DEV_API_BASE }}',
            EC2_TERMINAL_URL: '${{ env.DEV_TERMINAL_URL }}',
            GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}',
            PROD_VERSION: '4.0.0-dev',
            ENVIRONMENT: 'development',
            environment: 'development',
            stage: 'dev',
            region: 'us-east-1',
            storiesTable: '${{ env.DEV_DYNAMODB_STORIES_TABLE }}',
            acceptanceTestsTable: '${{ env.DEV_DYNAMODB_TESTS_TABLE }}',
            DEBUG: true
          };
          EOF
          
          aws s3 sync apps/frontend/public/ s3://${{ env.DEV_S3_BUCKET }} --delete --cache-control no-cache
          echo "âœ… Frontend deployed to Development S3"
      
      - name: Run Pre-Production Gating Tests
        id: gating
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_ENV: dev
          API_BASE: ${{ env.DEV_API_BASE }}
          SEMANTIC_API_BASE: ${{ env.DEV_SEMANTIC_API_BASE }}
          SSH_HOST: ${{ env.DEV_EC2_IP }}
          SKIP_GATING_TESTS: true
        run: |
          echo "ðŸ§ª Running Pre-Production Gating Tests on Development Environment"
          echo "   Backend: $API_BASE"
          echo "   Database: Development DynamoDB"
          export PHASE="pre-production"
          
          # Wait for deployment to be ready
          sleep 10
          
          # Run Phase 1 (Security & Data Safety) and Phase 2 (E2E Workflow)
          if ./scripts/testing/run-structured-gating-tests.sh --phases "1,2"; then
            echo "âœ… Pre-Production tests passed - production deployment approved"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Pre-Production tests failed"
            if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
              echo "âš ï¸ Force deploy enabled - proceeding despite test failures"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "ðŸš« Blocking production deployment"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

  # Step 2: Deploy to Production and run Post-Production tests
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-and-test-dev
    if: needs.deploy-and-test-dev.outputs.gating-status == 'success'
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Load Production environment configuration
        run: |
          source scripts/utilities/load-env-config.sh prod
          echo "PROD_EC2_IP=$EC2_IP" >> $GITHUB_ENV
          echo "PROD_API_BASE=$API_BASE" >> $GITHUB_ENV
          echo "PROD_SEMANTIC_API_BASE=$SEMANTIC_API_BASE" >> $GITHUB_ENV
          echo "PROD_TERMINAL_URL=$TERMINAL_URL" >> $GITHUB_ENV
          echo "PROD_S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          echo "PROD_S3_URL=$S3_URL" >> $GITHUB_ENV
          echo "PROD_DYNAMODB_STORIES_TABLE=$DYNAMODB_STORIES_TABLE" >> $GITHUB_ENV
          echo "PROD_DYNAMODB_TESTS_TABLE=$DYNAMODB_TESTS_TABLE" >> $GITHUB_ENV
      
      - name: Setup SSH key for deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          if echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
            echo "âœ… Decoded base64 SSH key"
          else
            echo "ðŸ“ Using raw SSH key"
            printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          fi
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $PROD_EC2_IP >> ~/.ssh/known_hosts
          ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1 && echo "âœ… SSH key configured" || (echo "âŒ SSH key validation failed" && exit 1)
      
      - name: Deploy backend to Production EC2
        run: |
          echo "ðŸš€ Deploying backend to Production EC2..."
          ./scripts/deploy-to-environment.sh prod
          echo "âœ… Backend deployed to Production EC2"
      
      - name: Deploy frontend to Production S3
        run: |
          echo "ðŸ“¦ Deploying frontend to Production S3..."
          
          # Create production config
          cat > apps/frontend/public/config.js << EOF
          window.CONFIG = {
            API_BASE_URL: '${{ env.PROD_API_BASE }}',
            EC2_TERMINAL_URL: '${{ env.PROD_TERMINAL_URL }}',
            GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}',
            PROD_VERSION: '4.0.0',
            ENVIRONMENT: 'production',
            environment: 'production',
            stage: 'prod',
            region: 'us-east-1',
            storiesTable: '${{ env.PROD_DYNAMODB_STORIES_TABLE }}',
            acceptanceTestsTable: '${{ env.PROD_DYNAMODB_TESTS_TABLE }}',
            DEBUG: false
          };
          EOF
          
          aws s3 sync apps/frontend/public/ s3://${{ env.PROD_S3_BUCKET }} --delete --cache-control no-cache
          echo "âœ… Frontend deployed to Production S3"
      
      - name: Run Post-Production Gating Tests
        id: post_deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_ENV: prod
          API_BASE: ${{ env.PROD_API_BASE }}
          SEMANTIC_API_BASE: ${{ env.PROD_SEMANTIC_API_BASE }}
          SSH_HOST: ${{ env.PROD_EC2_IP }}
        run: |
          echo "ðŸ” Running Post-Production Gating Tests on Production Environment"
          echo "   Backend: $API_BASE (Production EC2)"
          echo "   Database: Development DynamoDB (via X-Use-Dev-Tables header)"
          export PHASE="post-production"
          
          # Wait for deployment to be ready
          sleep 15
          
          # Test production environment health
          echo "Testing production environment..."
          
          # Frontend accessibility
          if curl -s "${{ env.PROD_S3_URL }}" | grep -q "AI Project Manager"; then
            echo "âœ… Production frontend accessible"
          else
            echo "âŒ Production frontend not accessible"
            exit 1
          fi
          
          # Backend API health
          if curl -s "$API_BASE/api/version" | grep -q "version"; then
            echo "âœ… Production backend healthy"
          else
            echo "âŒ Production backend not healthy"
            exit 1
          fi
          
          # Run gating tests with Production backend + Development DynamoDB
          if ./scripts/testing/run-structured-gating-tests.sh --phases "1,2"; then
            echo "âœ… Post-Production validation passed"
          else
            echo "âŒ Post-Production validation failed"
            exit 1
          fi
      
      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ steps.post_deployment.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Frontend: http://aipm-static-hosting-demo.s3-website-us-east-1.amazonaws.com" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Backend API: http://44.197.204.18:4000" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Semantic API: http://44.197.204.18:8083" >> $GITHUB_STEP_SUMMARY
